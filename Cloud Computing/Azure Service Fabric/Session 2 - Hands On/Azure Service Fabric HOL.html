<!DOCTYPE html>
<html>
<head>
<title>Azure Service Fabric HOL</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<style type="text/css">
/* GitHub stylesheet for MarkdownPad (http://markdownpad.com) */
/* Author: Nicolas Hery - http://nicolashery.com */
/* Version: b13fe65ca28d2e568c6ed5d7f06581183df8f2ff */
/* Source: https://github.com/nicolahery/markdownpad-github */

/* RESET
=============================================================================*/

html, body, div, span, applet, object, iframe, h1, h2, h3, h4, h5, h6, p, blockquote, pre, a, abbr, acronym, address, big, cite, code, del, dfn, em, img, ins, kbd, q, s, samp, small, strike, strong, sub, sup, tt, var, b, u, i, center, dl, dt, dd, ol, ul, li, fieldset, form, label, legend, table, caption, tbody, tfoot, thead, tr, th, td, article, aside, canvas, details, embed, figure, figcaption, footer, header, hgroup, menu, nav, output, ruby, section, summary, time, mark, audio, video {
  margin: 0;
  padding: 0;
  border: 0;
}

/* BODY
=============================================================================*/

body {
  font-family: Helvetica, arial, freesans, clean, sans-serif;
  font-size: 14px;
  line-height: 1.6;
  color: #333;
  background-color: #fff;
  padding: 20px;
  max-width: 960px;
  margin: 0 auto;
}

body>*:first-child {
  margin-top: 0 !important;
}

body>*:last-child {
  margin-bottom: 0 !important;
}

/* BLOCKS
=============================================================================*/

p, blockquote, ul, ol, dl, table, pre {
  margin: 15px 0;
}

/* HEADERS
=============================================================================*/

h1, h2, h3, h4, h5, h6 {
  margin: 20px 0 10px;
  padding: 0;
  font-weight: bold;
  -webkit-font-smoothing: antialiased;
}

h1 tt, h1 code, h2 tt, h2 code, h3 tt, h3 code, h4 tt, h4 code, h5 tt, h5 code, h6 tt, h6 code {
  font-size: inherit;
}

h1 {
  font-size: 28px;
  color: #000;
}

h2 {
  font-size: 24px;
  border-bottom: 1px solid #ccc;
  color: #000;
}

h3 {
  font-size: 18px;
}

h4 {
  font-size: 16px;
}

h5 {
  font-size: 14px;
}

h6 {
  color: #777;
  font-size: 14px;
}

body>h2:first-child, body>h1:first-child, body>h1:first-child+h2, body>h3:first-child, body>h4:first-child, body>h5:first-child, body>h6:first-child {
  margin-top: 0;
  padding-top: 0;
}

a:first-child h1, a:first-child h2, a:first-child h3, a:first-child h4, a:first-child h5, a:first-child h6 {
  margin-top: 0;
  padding-top: 0;
}

h1+p, h2+p, h3+p, h4+p, h5+p, h6+p {
  margin-top: 10px;
}

/* LINKS
=============================================================================*/

a {
  color: #4183C4;
  text-decoration: none;
}

a:hover {
  text-decoration: underline;
}

/* LISTS
=============================================================================*/

ul, ol {
  padding-left: 30px;
}

ul li > :first-child, 
ol li > :first-child, 
ul li ul:first-of-type, 
ol li ol:first-of-type, 
ul li ol:first-of-type, 
ol li ul:first-of-type {
  margin-top: 0px;
}

ul ul, ul ol, ol ol, ol ul {
  margin-bottom: 0;
}

dl {
  padding: 0;
}

dl dt {
  font-size: 14px;
  font-weight: bold;
  font-style: italic;
  padding: 0;
  margin: 15px 0 5px;
}

dl dt:first-child {
  padding: 0;
}

dl dt>:first-child {
  margin-top: 0px;
}

dl dt>:last-child {
  margin-bottom: 0px;
}

dl dd {
  margin: 0 0 15px;
  padding: 0 15px;
}

dl dd>:first-child {
  margin-top: 0px;
}

dl dd>:last-child {
  margin-bottom: 0px;
}

/* CODE
=============================================================================*/

pre, code, tt {
  font-size: 12px;
  font-family: Consolas, "Liberation Mono", Courier, monospace;
}

code, tt {
  margin: 0 0px;
  padding: 0px 0px;
  white-space: nowrap;
  border: 1px solid #eaeaea;
  background-color: #f8f8f8;
  border-radius: 3px;
}

pre>code {
  margin: 0;
  padding: 0;
  white-space: pre;
  border: none;
  background: transparent;
}

pre {
  background-color: #f8f8f8;
  border: 1px solid #ccc;
  font-size: 13px;
  line-height: 19px;
  overflow: auto;
  padding: 6px 10px;
  border-radius: 3px;
}

pre code, pre tt {
  background-color: transparent;
  border: none;
}

kbd {
    -moz-border-bottom-colors: none;
    -moz-border-left-colors: none;
    -moz-border-right-colors: none;
    -moz-border-top-colors: none;
    background-color: #DDDDDD;
    background-image: linear-gradient(#F1F1F1, #DDDDDD);
    background-repeat: repeat-x;
    border-color: #DDDDDD #CCCCCC #CCCCCC #DDDDDD;
    border-image: none;
    border-radius: 2px 2px 2px 2px;
    border-style: solid;
    border-width: 1px;
    font-family: "Helvetica Neue",Helvetica,Arial,sans-serif;
    line-height: 10px;
    padding: 1px 4px;
}

/* QUOTES
=============================================================================*/

blockquote {
  border-left: 4px solid #DDD;
  padding: 0 15px;
  color: #777;
}

blockquote>:first-child {
  margin-top: 0px;
}

blockquote>:last-child {
  margin-bottom: 0px;
}

/* HORIZONTAL RULES
=============================================================================*/

hr {
  clear: both;
  margin: 15px 0;
  height: 0px;
  overflow: hidden;
  border: none;
  background: transparent;
  border-bottom: 4px solid #ddd;
  padding: 0;
}

/* TABLES
=============================================================================*/

table th {
  font-weight: bold;
}

table th, table td {
  border: 1px solid #ccc;
  padding: 6px 13px;
}

table tr {
  border-top: 1px solid #ccc;
  background-color: #fff;
}

table tr:nth-child(2n) {
  background-color: #f8f8f8;
}

/* IMAGES
=============================================================================*/

img {
  max-width: 100%
}
</style>
<style type="text/css">
.highlight  { background: #ffffff; }
.highlight .c { color: #999988; font-style: italic } /* Comment */
.highlight .err { color: #a61717; background-color: #e3d2d2 } /* Error */
.highlight .k { font-weight: bold } /* Keyword */
.highlight .o { font-weight: bold } /* Operator */
.highlight .cm { color: #999988; font-style: italic } /* Comment.Multiline */
.highlight .cp { color: #999999; font-weight: bold } /* Comment.Preproc */
.highlight .c1 { color: #999988; font-style: italic } /* Comment.Single */
.highlight .cs { color: #999999; font-weight: bold; font-style: italic } /* Comment.Special */
.highlight .gd { color: #000000; background-color: #ffdddd } /* Generic.Deleted */
.highlight .gd .x { color: #000000; background-color: #ffaaaa } /* Generic.Deleted.Specific */
.highlight .ge { font-style: italic } /* Generic.Emph */
.highlight .gr { color: #aa0000 } /* Generic.Error */
.highlight .gh { color: #999999 } /* Generic.Heading */
.highlight .gi { color: #000000; background-color: #ddffdd } /* Generic.Inserted */
.highlight .gi .x { color: #000000; background-color: #aaffaa } /* Generic.Inserted.Specific */
.highlight .go { color: #888888 } /* Generic.Output */
.highlight .gp { color: #555555 } /* Generic.Prompt */
.highlight .gs { font-weight: bold } /* Generic.Strong */
.highlight .gu { color: #aaaaaa } /* Generic.Subheading */
.highlight .gt { color: #aa0000 } /* Generic.Traceback */
.highlight .kc { font-weight: bold } /* Keyword.Constant */
.highlight .kd { font-weight: bold } /* Keyword.Declaration */
.highlight .kp { font-weight: bold } /* Keyword.Pseudo */
.highlight .kr { font-weight: bold } /* Keyword.Reserved */
.highlight .kt { color: #445588; font-weight: bold } /* Keyword.Type */
.highlight .m { color: #009999 } /* Literal.Number */
.highlight .s { color: #d14 } /* Literal.String */
.highlight .na { color: #008080 } /* Name.Attribute */
.highlight .nb { color: #0086B3 } /* Name.Builtin */
.highlight .nc { color: #445588; font-weight: bold } /* Name.Class */
.highlight .no { color: #008080 } /* Name.Constant */
.highlight .ni { color: #800080 } /* Name.Entity */
.highlight .ne { color: #990000; font-weight: bold } /* Name.Exception */
.highlight .nf { color: #990000; font-weight: bold } /* Name.Function */
.highlight .nn { color: #555555 } /* Name.Namespace */
.highlight .nt { color: #000080 } /* Name.Tag */
.highlight .nv { color: #008080 } /* Name.Variable */
.highlight .ow { font-weight: bold } /* Operator.Word */
.highlight .w { color: #bbbbbb } /* Text.Whitespace */
.highlight .mf { color: #009999 } /* Literal.Number.Float */
.highlight .mh { color: #009999 } /* Literal.Number.Hex */
.highlight .mi { color: #009999 } /* Literal.Number.Integer */
.highlight .mo { color: #009999 } /* Literal.Number.Oct */
.highlight .sb { color: #d14 } /* Literal.String.Backtick */
.highlight .sc { color: #d14 } /* Literal.String.Char */
.highlight .sd { color: #d14 } /* Literal.String.Doc */
.highlight .s2 { color: #d14 } /* Literal.String.Double */
.highlight .se { color: #d14 } /* Literal.String.Escape */
.highlight .sh { color: #d14 } /* Literal.String.Heredoc */
.highlight .si { color: #d14 } /* Literal.String.Interpol */
.highlight .sx { color: #d14 } /* Literal.String.Other */
.highlight .sr { color: #009926 } /* Literal.String.Regex */
.highlight .s1 { color: #d14 } /* Literal.String.Single */
.highlight .ss { color: #990073 } /* Literal.String.Symbol */
.highlight .bp { color: #999999 } /* Name.Builtin.Pseudo */
.highlight .vc { color: #008080 } /* Name.Variable.Class */
.highlight .vg { color: #008080 } /* Name.Variable.Global */
.highlight .vi { color: #008080 } /* Name.Variable.Instance */
.highlight .il { color: #009999 } /* Literal.Number.Integer.Long */
.pl-c {
    color: #969896;
}

.pl-c1,.pl-mdh,.pl-mm,.pl-mp,.pl-mr,.pl-s1 .pl-v,.pl-s3,.pl-sc,.pl-sv {
    color: #0086b3;
}

.pl-e,.pl-en {
    color: #795da3;
}

.pl-s1 .pl-s2,.pl-smi,.pl-smp,.pl-stj,.pl-vo,.pl-vpf {
    color: #333;
}

.pl-ent {
    color: #63a35c;
}

.pl-k,.pl-s,.pl-st {
    color: #a71d5d;
}

.pl-pds,.pl-s1,.pl-s1 .pl-pse .pl-s2,.pl-sr,.pl-sr .pl-cce,.pl-sr .pl-sra,.pl-sr .pl-sre,.pl-src,.pl-v {
    color: #df5000;
}

.pl-id {
    color: #b52a1d;
}

.pl-ii {
    background-color: #b52a1d;
    color: #f8f8f8;
}

.pl-sr .pl-cce {
    color: #63a35c;
    font-weight: bold;
}

.pl-ml {
    color: #693a17;
}

.pl-mh,.pl-mh .pl-en,.pl-ms {
    color: #1d3e81;
    font-weight: bold;
}

.pl-mq {
    color: #008080;
}

.pl-mi {
    color: #333;
    font-style: italic;
}

.pl-mb {
    color: #333;
    font-weight: bold;
}

.pl-md,.pl-mdhf {
    background-color: #ffecec;
    color: #bd2c00;
}

.pl-mdht,.pl-mi1 {
    background-color: #eaffea;
    color: #55a532;
}

.pl-mdr {
    color: #795da3;
    font-weight: bold;
}

.pl-mo {
    color: #1d3e81;
}
.task-list {
padding-left:10px;
margin-bottom:0;
}

.task-list li {
    margin-left: 20px;
}

.task-list-item {
list-style-type:none;
padding-left:10px;
}

.task-list-item label {
font-weight:400;
}

.task-list-item.enabled label {
cursor:pointer;
}

.task-list-item+.task-list-item {
margin-top:3px;
}

.task-list-item-checkbox {
display:inline-block;
margin-left:-20px;
margin-right:3px;
vertical-align:1px;
}
</style>
</head>
<body>
<p><a name="HOLTitle"></a></p>
<h1>Developing Microservices with Azure Service Fabric</h1>
<hr>
<p><a name="Overview"></a></p>
<h2>Overview</h2>
<p>One of the more recent trends in enterprise architecture is the <a href="https://www.martinfowler.com/articles/microservices.html">Microservices architecture pattern</a>.  At its core, this pattern is a specialization of the Service Oriented Architecture pattern that gained popularity in the early 2000's, but extends that approach to focus on building small and independently deployable applications that communicate across lightweight protocols (including HTTP and TCP.)  This arrangement presents several advantages:</p>
<ul>
<li>Services are easy to both replace and maintain</li>
<li>Services can be scaled independently</li>
<li>Different programming tools &amp; techniques can be employed for discrete areas of a given solution</li>
</ul>
<p>Azure Service Fabric is a solution that supports developing and coordinating multiple services running within a cluster of virtual machines.  And while Service Fabric can be used to implement several different architectures, it is ideally suited to facilitate the development and orchestration of Microservices solutions.</p>
<p>Azure Service Fabric deployments can exist on-premises, in Microsoft Azure, or even in other vendors' clouds.  In Azure, however, Service Fabric offers a first-class experience whose benefits are not necessarily as easily attainable in other deployment environments.  As such, Service Fabric both offers a platform for service management, as well as a set of programming models &amp; related APIs.</p>
<p>It is important to note that while Service Fabric is one of the newer platform offerings within Microsoft Azure, it actually has been used internally by Microsoft for several years, powering Microsoft Cloud solutions that include Azure SQL Database, DocumentDB, Cortana, Microsoft Power BI, Microsoft Intune, Azure Event hHbs, Azure IoT Hub, Skype for Business, and others.  Additional information about Azure Service Fabric and its history can be found <a href="https://docs.microsoft.com/en-us/azure/service-fabric/service-fabric-overview">here</a>.</p>
<p>In this lab, you will learn how you can use Azure Service Fabric to build applications that implement a microservices architecture.  You will use Visual Studio 2017 to create an Azure Service Fabric application consisting of two services.  The first service will be a Stateless Service which will serve as the User Interface tier for the Inventory portion of a hypothetical catalog company.  The second service will be a Stateful Service which will provide RESTFul access to the inventory items.  Once both of these services have been created and communication is configured, you will explore how Azure Service Fabric provides scalability and resilience for the services it manages.</p>
<p><a name="Objectives"></a></p>
<h3>Objectives</h3>
<p>In this hands-on lab, you will learn how to:</p>
<ul>
<li>Create a new Service Fabric application using Visual Studio 2017.</li>
<li>Use the debugging and diagnostic tools provided by both Visual Studio and Service Fabric itself to run and monitor your Service Fabric application.</li>
<li>Configure communication between multiple services in a Service Fabric application.</li>
<li>Leverage partitioning and Reliable Services in order to provide scalability and fault-tolerance in a Service Fabric application.</li>
</ul>
<p><a name="Prerequisites"></a></p>
<h3>Prerequisites</h3>
<p>The following are required to complete this hands-on lab:</p>
<ul>
<li>Visual Studio 2017 (Community Edition or higher) with the "<em>Azure development</em>" workload installed.  The Visual Studio 2017 installer can be downloaded <a href="https://www.visualstudio.com/vs/">here</a>.  Note that this lab is only supported on the Windows OS.</li>
<li>An active Microsoft Azure subscription. If you do not already have an Azure subscription, you can <a href="http://aka.ms/WATK-FreeTrial">sign up for a free trial</a>.</li>
</ul>
<p><a name="Exercises"></a></p>
<h2>Exercises</h2>
<p>This hands-on lab includes the following exercises:</p>
<ul>
<li><a href="#Exercise1">Exercise 1: Creating a new Service Fabric Project with Visual Studio 2017</a></li>
<li><a href="#Exercise2">Exercise 2: Running a Service Fabric Application in the Service Fabric Local Cluster Manager</a></li>
<li><a href="#Exercise3">Exercise 3: Adding Another Service in the Service Fabric Cluster</a></li>
<li><a href="#Exercise4">Exercise 4: Communicating Between Services in a Service Fabric Cluster</a></li>
<li><a href="#Exercise5">Exercise 5: Enable Partitioning and Show Node Failover</a></li>
</ul>
<p>Estimated time to complete this lab: <strong>60</strong> minutes.</p>
<p><a name="Exercise1"></a></p>
<h2>Exercise 1: Creating a new Service Fabric Project with Visual Studio 2017</h2>
<p>In this exercise, you will create and examine a new Azure Service Fabric application using Visual Studio 2017.  In order to build and debug Azure Service Fabric applications using Visual Studio 2017 on your development machine, the following are requirements must be met:</p>
<ul>
<li>You need to be running Windows 7(SP1), 8.1, or 10 or Windows Server 2012 R2 or 2016.</li>
<li>Visual Studio 2017 with the <em>Azure development</em> workload installed (Visual Studio 2015 Update 2 can also be used, but Visual Studio 2017 will be assumed throughout these lab instructions.)</li>
<li>You need to install the <em>Microsoft Azure Service Fabric Core SDK</em>, which you can obtain <a href="http://www.microsoft.com/web/handlers/webpi.ashx?command=getinstallerredirect&amp;appid=MicrosoftAzure-ServiceFabric-CoreSDK">here</a>.</li>
<li>PowerShell 3.0 or newer must be installed with the execution policy set to "Unrestricted" for the administrator user.
<ul>
<li>You can achieve this configuration by running PowerShell as an administrator and executing the following command:<br>
<code>Set-ExecutionPolicy -ExecutionPolicy Unrestricted -Force -Scope CurrentUser</code></li>
</ul>
</li>
</ul>
<p>Additional information about configuring your development environment can be found <a href="https://docs.microsoft.com/en-us/azure/service-fabric/service-fabric-get-started">here</a>.</p>
<p>Once you have your development environment properly configured, your first step is to create a Service Fabric Application project in Visual Studio 2017.</p>
<ol>
<li>
<p>Run Visual Studio 2017 as an administrator.  This elevation of privileges for Visual Studio is required in order for it to work with the <em>Service Fabric Local Cluster Manager</em>, which allows you to deploy, run, and debug Service Fabric applications within your development machine.</p>
<blockquote>
<p>In Windows 10, to run Visual Studio as an Administrator, you can first type <strong>Visual Studio 2017</strong> into the Windows search bar.  In the <strong>Best Match</strong> section of the search results, right-click on the <strong>Visual Studio 2017</strong> entry, and select <strong>Run as administrator</strong> from the dropdown.  When the <em>User Account Control (UAC)</em> dialog is displayed to confirm that you want to run Visual Studio this way, select <strong>Yes</strong>.</p>
</blockquote>
<p><a href="Images/start-run_vs_as_admin.png" target="_blank"><img src="Images/start-run_vs_as_admin.png" alt="Running Visual Studio as an Administrator" style="max-width:100%;"></a></p>
<p><em>Running Visual Studio as an Administrator</em></p>
<blockquote>
<p>Note - When Visual Studio 2017 is running with administrator privileges, the application title will be displayed in the title bar with the word <em>(Administrator)</em> in parentheses at the end.</p>
</blockquote>
</li>
<li>
<p>In Visual Studio, select <strong>New</strong> from the <strong>File</strong> menu, and then click on <strong>Project</strong>.</p>
<p><a href="Images/start-file_newproject.png" target="_blank"><img src="Images/start-file_newproject.png" alt="Creating a new project" style="max-width:100%;"></a></p>
<p><em>Creating a new project</em></p>
</li>
<li>
<p>In the <strong>New Project</strong> dialog, select the <strong>Cloud</strong> node and then <strong>Service Fabric Application</strong> from within the <strong>Cloud</strong> node.</p>
<ul>
<li>Enter <em>ServiceFabricLab</em> for the project <strong>Name</strong>.</li>
<li>Leave the <strong>Location</strong> set to the default value.</li>
<li>Leave the <strong>Solution</strong> name set to the default value.</li>
<li>Click the <strong>OK</strong> button to create the project.</li>
</ul>
<p><a href="Images/start-newproject_settings.png" target="_blank"><img src="Images/start-newproject_settings.png" alt="New project settings" style="max-width:100%;"></a><br>
<em>New project settings</em></p>
</li>
<li>
<p>The <strong>New Service Fabric Service</strong> dialog will be displayed.  This dialog shows the different types of services that can be included in a Service Fabric application.   Select <strong>ASP.NET Core</strong> and set the name to <strong>InventoryService</strong>.  Click <strong>OK</strong> to dismiss the dialog.</p>
<p><a href="Images/start-newservicefabricservice_settings.png" target="_blank"><img src="Images/start-newservicefabricservice_settings.png" alt="New Service Fabric service" style="max-width:100%;"></a></p>
<p><em>New Service Fabric Service</em></p>
</li>
<li>
<p>In the dialog titled <strong>New ASP.NET Core Web Application (.NET Framework) - Inventory Service</strong>, make sure <strong>ASP.NET Core 1.1</strong> is selected in the framework dropdown.  Select the <strong>Web Application</strong> template, and then click on the <strong>OK</strong> button.</p>
<p><a href="Images/start-newaspnetcoreapp_template.png" target="_blank"><img src="Images/start-newaspnetcoreapp_template.png" alt="Web Application Template" style="max-width:100%;"></a></p>
<p><em>Web Application Template</em></p>
</li>
<li>
<p>Take a minute to look over the contents of the <em>Solution Explorer</em> in Visual Studio 2017.</p>
<p>The solution contains two projects - <strong>InventoryService</strong> and <strong>ServiceFabricLab</strong>.  Service Fabric solutions consist of one or more Service Fabric Service projects, as well as a Service Fabric Application project.</p>
<p><a href="Images/start-solutionexplorer.png" target="_blank"><img src="Images/start-solutionexplorer.png" alt="The Service Fabric Application Solution" style="max-width:100%;"></a></p>
<p><em>The Service Fabric Application Solution</em></p>
</li>
<li>
<p>Examine the <strong>ServiceFabricLab</strong> project.</p>
<p>This project is the Service Fabric Application project for this solution. This project does not contain any code, but instead contains links to the services that are included in your Service Fabric application and information describing how your application will be packaged and deployed.</p>
<p>One of the more important elements contained in the Service Fabric Application project is the <em>application manifest</em> file.  This file is named <em>ApplicationManifest.xml</em> and is located in the <em>ApplicationPackageRoot</em> folder.  The application manifest is an XML file that describes your configuration to Service Fabric.</p>
</li>
<li>
<p>Now examine the <strong>InventoryService</strong> project.</p>
<p>This project is a Stateless Service Fabric Service project.  If you examine the project properties for this project, you will see it is actually a .NET Core Console Application.  This is a self-hosted Web application (one that does not rely on IIS as an external HTTP Server), which hosts the WebListener server within the processes managed by the Service Fabric runtime.  Additional information about WebListener can be found <a href="https://docs.microsoft.com/en-us/aspnet/core/fundamentals/servers/weblistener">here</a>.</p>
</li>
<li>
<p>Open the <em>Program.cs</em> file from the <em>InventoryService</em> project. This file contains the following code:</p>
<div class="highlight highlight-source-cs"><pre><span class="pl-en">ServiceRuntime.RegisterServiceAsync</span>("InventoryServiceType",
    context =&gt; <span class="pl-k">new</span> <span class="pl-en">InventoryService</span>(<span class="pl-en">context</span>)).GetAwaiter().GetResult(); </pre></div>
<p>This code registers the Inventory Service with the Service Fabric runtime.  The <code>InventoryService</code> class is an instance of the <code>StatelessService</code> class defined in the Service Fabric SDK.</p>
</li>
<li>
<p>Now open the <em>InventoryService.cs</em> file.  Locate the <code>CreateServiceInstanceListeners</code> method override.  This method is called by the Service Fabric runtime to configure the endpoints on which this service will listen for messages.  In this case, it is configuring an instance of the <code>WebListenerCommunicationListener</code> class, which is used to connect Service Fabric to a <em>WebListener</em> HTTP service.</p>
<p>The following code configures the WebListener:</p>
<div class="highlight highlight-source-cs"><pre><span class="pl-k">return</span> <span class="pl-k">new</span> <span class="pl-en">WebHostBuilder</span>().<span class="pl-en">UseWebListener</span>()
        .<span class="pl-en">ConfigureServices</span>(
            services =&gt; services
                .AddSingleton&lt;StatelessServiceContext&gt;(serviceContext))
        .<span class="pl-en">UseContentRoot</span>(Directory.GetCurrentDirectory())
        .<span class="pl-en">UseStartup</span>&lt;<span class="pl-en">Startup</span>&gt;()
        .<span class="pl-en">UseApplicationInsights</span>()
        .<span class="pl-en">UseUrls</span>(url)
        .<span class="pl-en">Build</span>();</pre></div>
<p>At this point, the application is basically a standard <em>ASP.NET Core 1.1</em> MVC Web application.  ASP.NET Core is a rich framework for building Web applications, and a detailed description of programming it is beyond the scope of this lab.  Additional information about ASP.NET Core can be found <a href="https://www.asp.net/core">here</a>.</p>
</li>
</ol>
<p><a name="Exercise2"></a></p>
<h2>Exercise 2: Running a Service Fabric Application in the Service Fabric Local Cluster Manager</h2>
<p>Now that you have created a basic Service Fabric application project in Visual Studio 2017, it's time to see the application in action.  In this exercise, you will deploy your application to the Service Fabric Local Cluster Manager on your development machine and examine the running service using both Visual Studio 2017 and the Service Fabric Cluster manager.</p>
<ol>
<li>
<p>Click on the <strong>Start</strong> button in Visual Studio 2017.  This will deploy your Service Fabric application to your local Service Fabric cluster and then open your default Web browser to your service's URL.</p>
<p><a href="Images/debug-startservice_indebugger.png" target="_blank"><img src="Images/debug-startservice_indebugger.png" alt="Starting the Service Fabric Application from Visual Studio 2017" style="max-width:100%;"></a></p>
<p><em>Starting the Service Fabric Application from Visual Studio 2017</em></p>
<blockquote>
<p>Note - depending on whether this is the first time you are deploying conten to your Service Fabric Local Cluster Manager, this step may take a couple minutes as the local cluster is prepared for first-time use.</p>
</blockquote>
<p>If the service fails to run with a deployment error,be sure to check that you are running Visual Studio 2017 as an administrator.</p>
<p><a href="Images/debug-apprunning_inbrowser.png" target="_blank"><img src="Images/debug-apprunning_inbrowser.png" alt="The Service Fabric Application Running in a Web Browser" style="max-width:100%;"></a></p>
<p><em>The Service Fabric Application Running in a Web Browser</em></p>
</li>
<li>
<p>In addition to the application being launched in your Web browser, running your application for debugging in Visual Studio 2017 will also open a <em>Diagnostic Events</em> window within the IDE.</p>
<p><a href="Images/debug-diagnosticeventswindow.png" target="_blank"><img src="Images/debug-diagnosticeventswindow.png" alt="The Diagnostic Events view in Visual Studio 2017" style="max-width:100%;"></a></p>
<p><em>The Diagnostic Events view in Visual Studio 2017</em></p>
<p>The default templates for Service Fabric Service applications in Visual Studio 2017 include a <code>ServiceEventSource</code> class.  This class registers your application and provides helper events for writing trace and diagnostic information to <em>Event Tracing for Windows</em> (ETW).</p>
<p>ETW is a high-performance tracing technology that is built into Windows.  Your applications can leverage the code provided in <em>ServiceEventSource</em> to write application-specific diagnostic information into ETW in order to help you better understand and troubleshoot your service's behavior.  More information about ETW can be found <a href="https://msdn.microsoft.com/library/windows/desktop/bb968803.aspx">here</a>.</p>
</li>
<li>
<p>You will now see how you can set and trap a debugger breakpoint in your service fabric application.  Open the <strong>HomeController.cs</strong> file located in the <strong>Controllers</strong> folder in the <em>InventoryService</em> project.  Place your cursor at the start of the return statement in the <code>public IActionResult About()</code> method and use the F9 key on your keyboard to place a breakpoint at this line.</p>
<p><a href="Images/debug-aboutmethod_breakpoint.png" target="_blank"><img src="Images/debug-aboutmethod_breakpoint.png" alt="Setting an Application Breakpoint" style="max-width:100%;"></a></p>
<p><em>Setting an Application Breakpoint</em></p>
</li>
<li>
<p>Return to your Web browser and click on the <em>About</em> link at the top of the page.</p>
<p><a href="Images/debug-clickon_about.png" target="_blank"><img src="Images/debug-clickon_about.png" alt="Clicking the About Link" style="max-width:100%;"></a></p>
<p><em>Clicking the About Link</em></p>
</li>
<li>
<p>Return to Visual Studio 2017.  Notice that the application execution is indeed suspended at the breakpoint that you set, just as you would expect when debugging any other type of .NET application.  Clicking the <strong>Continue</strong> button in Visual Studio 2017 (or pressing the <strong>F5</strong> key on your keyboard will resume application execution, and the <em>About</em> page should now be displayed in your Web browser.</p>
</li>
<li>
<p>The final set of steps in this exercise is to examine the <em>Service Fabric Explorer</em> Web application.  The <em>Service Fabric Explorer</em> is a Web-based tool that you can use to both see and manage the status of your Service Fabric application in a cluster.</p>
<p>With your application still running, locate the <em>Service Fabric Local Cluster Manager</em> icon in the Windows System Tray.  Right-click on the icon and select <strong>Manage Local Cluster</strong> from the menu that is displayed.</p>
<p><a href="Images/debug-systemtray_managelocalcluster.png" target="_blank"><img src="Images/debug-systemtray_managelocalcluster.png" alt="Launching the Local Cluster Manager Site" style="max-width:100%;"></a></p>
<p><em>Launching the Local Cluster Manager Site</em></p>
<p>This will open the <em>Service Fabric Explorer</em> for your site in your Web browser.</p>
<p><a href="Images/debug-servicefabricexplorer.png" target="_blank"><img src="Images/debug-servicefabricexplorer.png" alt="The Service Fabric Explorer" style="max-width:100%;"></a></p>
<p><em>The Service Fabric Explorer</em></p>
</li>
<li>
<p>The <em>Service Fabric Explorer</em> interface is broken into 2 main sections.  The tree on the left side allows you to navigate through the parts that make up your cluster, and the panel on the right shows the details for what has been selected on the left.</p>
<p>The initial display is the main cluster dashborad view.  This view offers at-a-glance information about your cluster's health, including the number and status of deployed applications and the number and status of the nodes in use in the cluster.  Using the section links at the top of the cluster display, you can also:</p>
<ul>
<li>See detailed information about the overall cluster</li>
<li>See a map illustrating the layout of the cluster</li>
<li>Health metrics for the cluster</li>
<li>The application manifest that describes the application deployment in the cluster.</li>
</ul>
</li>
<li>
<p>You can also view information about the applications and services deployed to the cluster using the <em>Applications</em> node in the navigation tree.  Click on the chevron next to the <strong>Applications</strong> link on the left-side navigation, then click on the chevron next to the <strong>ServiceFabricLabType</strong> entry, then click on the chevron next to the <strong>fabric:/ServiceFabricLab</strong> application entry, and again click on the chevron next to the <strong>fabric:/ServiceFabricLab/InventoryService</strong> service entry.  Finally, click on the entry under the <strong>fabric:/ServiceFabricLab/InventoryService</strong> branch to select the running service partition.</p>
<p><a href="Images/debug-expandtree_toservicepartition.png" target="_blank"><img src="Images/debug-expandtree_toservicepartition.png" alt="Locating the Service Fabric Service Partition" style="max-width:100%;"></a></p>
<p>_Locating the Service Fabric Service Partition</p>
</li>
<li>
<p>In the display area for the selected service partition, locate the <strong>Instances</strong> section and notice the <strong>Node Name</strong> value</p>
<p><a href="Images/debug-partition_information.png" target="_blank"><img src="Images/debug-partition_information.png" alt="Locating the Service Fabric Service Partition" style="max-width:100%;"></a></p>
<p><em>Locating the Service Fabric Service Partition</em></p>
</li>
<li>
<p>Finally, expand the <strong>Nodes</strong> link in the left-side navigation and expand the node that corresponds to the Node Name you obtained in the previous step.  Spend some time exploring the contents of this node to see some of the information that is available.</p>
<p><a href="Images/debug-nodeinformation.png" target="_blank"><img src="Images/debug-nodeinformation.png" alt="Examining the Application Node Information" style="max-width:100%;"></a></p>
<p><em>Examining the Application Node Information</em></p>
</li>
<li>
<p>Close you Web browser.  To stop your cluster, click on the <strong>Debug</strong> menu in Visual Studio 2017 and then click on <strong>Stop Debugging</strong>.  By default, Visual Studio 2017 will remove your deployed application from the Service Fabric Local Cluster Manager.</p>
</li>
</ol>
<p><a name="Exercise3"></a></p>
<h2>Exercise 3: Adding Another Service in the Service Fabric Cluster</h2>
<p>In this exercise, you will add a new Stateful Service to the Service Fabric application that you created and worked with in the previous exercises. This service will act as a repository service for a hypothetical Product Inventory system, using the Service Fabric Stateful Service Reliable Collections to hold information and exposing access to this information via RESTful Web API endpoints.</p>
<ol>
<li>
<p>Open the File menu in Visual Studio 2017.  In the dropdown menu, click on <strong>Add</strong> and then on <strong>New Project...</strong></p>
<p><a href="Images/start-file_newproject.png" target="_blank"><img src="Images/start-file_newproject.png" alt="Creating a new project" style="max-width:100%;"></a></p>
<p><em>Creating a new project</em></p>
</li>
<li>
<p>In the <strong>New Project</strong> dialog, select the Visual C# node and then click on the Class Library (.NET Framework) entry.</p>
<ul>
<li>Enter <em>InventoryCommon</em> for the project <strong>Name</strong>.</li>
<li>Leave the <strong>Location</strong> set to the default value.</li>
<li>Click the <strong>OK</strong> button to create the project.</li>
</ul>
<p><a href="Images/addservice-newclasslibrary_settings.png" target="_blank"><img src="Images/addservice-newclasslibrary_settings.png" alt="New project settings" style="max-width:100%;"></a><br>
<em>New project settings</em></p>
<p>Delete the <em>Class1.cs</em> file from the new <em>InventoryCommon</em> project.</p>
</li>
<li>
<p>Right-click on the InventoryCommon project entry in the Solution Explorer.  In the context menu, click on Add and then on Existing Item...</p>
<p><a href="Images/addservice-add_existingitem_common.png" target="_blank"><img src="Images/addservice-add_existingitem_common.png" alt="Add an Existing Item to the Common Project" style="max-width:100%;"></a></p>
<p><em>Add an Existing Item to the Common Project</em></p>
</li>
<li>
<p>In the <em>Add Existing Item</em> dialog, browse to the folder where this lab content is located and open the <em>Assets</em> folder.  Select the <strong>InventoryItem.cs</strong> file and click on the <strong>Add</strong> button.</p>
<p><a href="Images/addservice-add_inventoryitemfile.png" target="_blank"><img src="Images/addservice-add_inventoryitemfile.png" alt="Add the InventoryItem File" style="max-width:100%;"></a></p>
<p><em>Add the InventoryItem File</em></p>
<blockquote>
<p>This file contains the definition of an <code>InventoryItem</code> type that will be exchanged between services in the application.  It also contains the related <code>InventoryItemType</code> that will be used to categorize the inventory items.  In a later exercise, this value will be used as a key to divide the application deployment into separate service partiions.</p>
</blockquote>
</li>
<li>
<p>In the <strong>ServiceFabricLab</strong> project, right-click on the <strong>Services</strong> node.  Click <strong>Add</strong> and then click <strong>New Service Fabric Service...</strong> from the popup menus.</p>
<p><a href="Images/addservice-infoke_addnewservice.png" target="_blank"><img src="Images/addservice-infoke_addnewservice.png" alt="Add a New Service" style="max-width:100%;"></a></p>
<p><em>Add a New Service</em></p>
</li>
<li>
<p>In the New Service Fabric Service dialog, click on the the <strong>Stateful Service</strong> option and enter the name <strong>InventoryRepository</strong> for the Service Name.  Click the <strong>OK</strong> button to close the dialog.</p>
<p><a href="Images/addservice-newservicefabricservice_settings.png" target="_blank"><img src="Images/addservice-newservicefabricservice_settings.png" alt="New Service Fabric Service" style="max-width:100%;"></a></p>
<p><em>New Service Fabric Service</em></p>
<p>This will add a new <em>InventoryRepository</em> project to your Visual Studio 2017 solution.</p>
</li>
<li>
<p>The next step is to configure the new service to respond to HTTP REST requests.  In the Solution Explorer in Visual Studio 2017, right-click on the <strong>References</strong> node in the <strong>InventoryRepository</strong> project and click on <strong>Manage NuGet Packages...</strong> in the context menu.</p>
</li>
<li>
<p>In the NuGet window in Visual Studio, select <strong>Browse</strong>.  Type (or paste) <em><strong>Microsoft.AspNet.WebApi.OwinSelfHost</strong></em> into the Search box.  Select the <em><strong>Microsoft.AspNet.WebApi.OwinSelfHost</strong></em> entry in the search results and click the Install button.</p>
<p><a href="Images/addservice-add_ownselfhostnugetpackage.png" target="_blank"><img src="Images/addservice-add_ownselfhostnugetpackage.png" alt="Adding the OWIN Self-Host Nuget Package" style="max-width:100%;"></a></p>
<p><em>Adding the OWIN Self-Host Nuget Package</em></p>
<p>In the <strong>Preview</strong> dialog, click the <strong>OK</strong> button to verify the list of packages being installed, and in the <strong>License Acceptance</strong> dialog, click the <strong>I Accept</strong> button to accept the terms associated with these packages.</p>
</li>
<li>
<p>When the NuGet package installation completes, right-click on the <strong>InventoryRepository</strong> project entry in the Solution Explorer.  Click on <strong>Add</strong> and then click on <strong>Existing Item</strong> in the popup menus.</p>
<p><a href="Images/addservice-add_existingitem.png" target="_blank"><img src="Images/addservice-add_existingitem.png" alt="Add an Existing Item to the Service Project" style="max-width:100%;"></a></p>
<p><em>Add an Existing Item to the Service Project</em></p>
</li>
<li>
<p>In the <em>Add Existing Item</em> dialog, browse to the folder where this lab content is located and open the <em>Assets</em> folder.  Select the <strong>OwinCommunicationListener.cs</strong> file and click on the <strong>Add</strong> button.</p>
<p><a href="Images/addservice-add_owincommunicationlistenerfile.png" target="_blank"><img src="Images/addservice-add_owincommunicationlistenerfile.png" alt="Add the OWINCommunicationListener File" style="max-width:100%;"></a></p>
<p><em>Add the OWINCommunicationListener File</em></p>
</li>
<li>
<p>Open the <strong>InventoryRepository.cs</strong> file in Visual Studio 2017.  Add the following <code>using</code> statements at the top of the file.</p>
<div class="highlight highlight-source-cs"><pre><span class="pl-k">using</span> <span class="pl-en">System.Fabric.Description</span>;
<span class="pl-k">using</span> <span class="pl-en">InventoryRepository.ServiceFabric</span>;</pre></div>
</li>
<li>
<p>Next, delete the entire <code>RunAsync</code> method declaration and its contents, then update the <code>CreateServiceReplicaListeners</code> method to contain the following block of code:</p>
<div class="highlight highlight-source-cs"><pre><span class="pl-k">var</span> <span class="pl-en">endpoints </span>= <span class="pl-en">Context.CodePackageActivationContext.GetEndpoints</span>()
           .<span class="pl-en">Where</span>(endpoint =&gt; endpoint.Protocol == EndpointProtocol.Http || endpoint.Protocol == EndpointProtocol.Https)
           .<span class="pl-en">Select</span>(endpoint =&gt; endpoint.Name);

<span class="pl-k">return</span> <span class="pl-en">endpoints.Select</span>(
    endpoint =&gt; <span class="pl-k">new</span> <span class="pl-en">ServiceReplicaListener</span>(
        serviceContext =&gt; <span class="pl-k">new</span> <span class="pl-en">OwinCommunicationListener</span>(
            appBuilder =&gt; { WebHostStartup.ConfigureApp(appBuilder, StateManager); }, 
            serviceContext, 
            ServiceEventSource.Current, 
            endpoint), 
        endpoint));</pre></div>
<p>This code locates the declared HTTP or HTTPS endpoints for the current service.  It then returns a new <code>ServiceReplicaListener</code> instance for each, which builds on top of the <code>OwinCommunicationListener</code> class that was in the file you just added to the project.  Additionally, it indicates that the OWIN pipeline should be initialized with the <code>WebHostStartup</code> class, which was also contained in that same file.</p>
</li>
<li>
<p>The next step is to open the <strong>ServiceManifest.xml</strong> file in the project's <strong>PackageRoot</strong> folder.  Locate the <code>&lt;Endpoint Name="ServiceEndpoint" /&gt;</code> entry and replace it with the following, which configures the application to expose an HTTP endpoint on port 8081, and drives the configuration code in the previous step.</p>
<div class="highlight highlight-text-xml"><pre>&lt;<span class="pl-ent">Endpoint</span> <span class="pl-e">Name</span>=<span class="pl-s"><span class="pl-pds">"</span>ServiceEndpoint<span class="pl-pds">"</span></span> <span class="pl-e">Type</span>=<span class="pl-s"><span class="pl-pds">"</span>Input<span class="pl-pds">"</span></span> <span class="pl-e">Protocol</span>=<span class="pl-s"><span class="pl-pds">"</span>http<span class="pl-pds">"</span></span> <span class="pl-e">Port</span>=<span class="pl-s"><span class="pl-pds">"</span>8081<span class="pl-pds">"</span></span>/&gt;</pre></div>
</li>
<li>
<p>In the Solution Explorer in Visual Studio 2017, right-click on the <strong>References</strong> node in the <strong>InventoryRepository</strong> project and click on <strong>Add References...</strong> in the context menu.</p>
</li>
<li>
<p>In the <strong>Reference Manager</strong> dialog, select the <strong>Projects</strong> node and then click the checkbox next to the <strong>InventoryCommon</strong> project entry.  Click the <strong>OK</strong> button to add the reference.</p>
<p><a href="Images/addservice-addreference_tocommonlibrary.png" target="_blank"><img src="Images/addservice-addreference_tocommonlibrary.png" alt="Add A Reference to the InventoryCommon Project" style="max-width:100%;"></a></p>
<p><em>Add A Reference to the InventoryCommon Project</em></p>
</li>
<li>
<p>In the Solution Explorer in Visual Studio 2017, right-click on the <strong>InventoryRepository</strong> project.  Click on <strong>Add</strong> and then click on the <strong>New Folder</strong> in the context menus.  Name the folder <strong>Controllers</strong>.</p>
</li>
<li>
<p>Right-click on the <em>Controllers</em> folder.  Click on <strong>Add</strong> and then click on <strong>Class...</strong> in the context menus.  In the <strong>AddNewItem - InventoryRepository</strong> dialog, name the class <strong>InventoryController.cs</strong> and click the <strong>Add</strong> button.</p>
</li>
<li>
<p>Replace the code in the <code>InventoryController</code> class with the following block:</p>
<div class="highlight highlight-source-cs"><pre><span class="pl-k">using</span> <span class="pl-en">System</span>;
<span class="pl-k">using</span> <span class="pl-en">System.Collections.Generic</span>;
<span class="pl-k">using</span> <span class="pl-en">System.Threading</span>;
<span class="pl-k">using</span> <span class="pl-en">System.Threading.Tasks</span>;
<span class="pl-k">using</span> <span class="pl-en">System.Web.Http</span>;
<span class="pl-k">using</span> <span class="pl-en">Microsoft.ServiceFabric.Data</span>;
<span class="pl-k">using</span> <span class="pl-en">Microsoft.ServiceFabric.Data.Collections</span>;
<span class="pl-k">using</span> <span class="pl-en">InventoryCommon</span>;
<span class="pl-k">using</span> <span class="pl-en">InventoryRepository.ServiceFabric</span>;

<span class="pl-k">namespace</span> <span class="pl-en">InventoryRepository.Controllers</span>
{
    [RoutePrefix(<span class="pl-s"><span class="pl-pds">"</span>api/inventory<span class="pl-pds">"</span></span>)]
    <span class="pl-k">public</span> <span class="pl-k">class</span> <span class="pl-en">InventoryController</span> : <span class="pl-en">ApiController</span>
    {
        <span class="pl-k">private readonly </span><span class="pl-en">IReliableStateManager</span> <span class="pl-en">_stateManager</span>;

        <span class="pl-k">public</span> <span class="pl-en">InventoryController</span>()
        {
            _stateManager = WebHostStartup.StateManager;
        }
    }
}</pre></div>
</li>
<li>
<p>Add the following GetItem(s) methods to the <code>InventoryController</code> class:</p>
<div class="highlight highlight-source-cs"><pre>[HttpGet]
[Route(<span class="pl-s"><span class="pl-pds">"</span><span class="pl-pds">"</span></span>)]
<span class="pl-k">public</span> <span class="pl-k">async</span> <span class="pl-en">Task</span>&lt;<span class="pl-en">IEnumerable</span>&lt;<span class="pl-en">InventoryItem</span>&gt;&gt; <span class="pl-en">GetItems</span>()
{
    <span class="pl-k">using</span> (<span class="pl-k">var</span> <span class="pl-en">tx </span>= _stateManager.CreateTransaction())
    {
        <span class="pl-k">var</span> <span class="pl-en">inventoryDictionary </span>= <span class="pl-k">await</span> _stateManager.GetOrAddAsync&lt;IReliableDictionary&lt;Guid, InventoryItem&gt;&gt;(<span class="pl-s"><span class="pl-pds">"</span>inventoryDictionary<span class="pl-pds">"</span></span>);
        <span class="pl-k">var</span> <span class="pl-en">items </span>= <span class="pl-k">await</span> inventoryDictionary.CreateEnumerableAsync(tx);

        <span class="pl-k">var</span> <span class="pl-en">result </span>= <span class="pl-k">new</span> <span class="pl-en">List</span>&lt;InventoryItem&gt;();
        <span class="pl-k">using</span> (<span class="pl-k">var</span> <span class="pl-en">enumerator </span>= items.GetAsyncEnumerator())
        {
            <span class="pl-k">while</span> (<span class="pl-k">await</span> enumerator.MoveNextAsync(CancellationToken.None))
            {
                result.Add(enumerator.Current.Value);
            }
            <span class="pl-k">return</span> result;
        }
    }
}

[HttpGet]
[Route(<span class="pl-s"><span class="pl-pds">"</span>{itemId}<span class="pl-pds">"</span></span>)]
<span class="pl-k">public</span> <span class="pl-k">async</span> <span class="pl-en">Task</span>&lt;<span class="pl-en">InventoryItem</span>&gt; <span class="pl-en">GetItem</span>(<span class="pl-en">Guid</span> <span class="pl-smi">itemId</span>)
{
    <span class="pl-k">using</span> (<span class="pl-k">var</span> <span class="pl-en">tx </span>= _stateManager.CreateTransaction())
    {
        <span class="pl-k">var</span> <span class="pl-en">inventoryDictionary </span>= <span class="pl-k">await</span> _stateManager.GetOrAddAsync&lt;IReliableDictionary&lt;Guid, InventoryItem&gt;&gt;(<span class="pl-s"><span class="pl-pds">"</span>inventoryDictionary<span class="pl-pds">"</span></span>);
        <span class="pl-k">var</span> <span class="pl-en">item </span>= <span class="pl-k">await</span> inventoryDictionary.TryGetValueAsync(tx, itemId);
        <span class="pl-k">return</span> item.HasValue ? item.Value : <span class="pl-c1">null</span>;
    }
}</pre></div>
<p>In both of these methods, the Service Fabric Stateful Services' <code>StateMenager</code> is used to create a transaction scope for the operations.  The next step either retrieves a <code>ReliableDictionary</code> named <em>"inventoryDictionary"</em> if it exists; otherwise the dictionary is created.</p>
<blockquote>
<p>The <code>ReliableDictionary</code> is a part of the <em>Reliable Collection</em> types offered by Service Fabric.  Reliable collections support high-availability, scalability, and speed while offering a programming model that is similar to one that would be used for single-computer applications.  As of this writing, there are two memebrs of the Service Fabric Reliable Collections - <code>ReliableDictionary</code> and <code>ReliableQueue</code>.  You can learn more about the Service Fabric Reliable Collections <a href="https://docs.microsoft.com/en-us/azure/service-fabric/service-fabric-reliable-services-reliable-collections">here</a>.</p>
</blockquote>
<p>Finally, the dictionary is either iterated or searched for a specific item and the results are returned.</p>
</li>
<li>
<p>Add the following AddNewItem method to the <code>InventoryController</code> class:</p>
<div class="highlight highlight-source-cs"><pre>[HttpPost]
[Route(<span class="pl-s"><span class="pl-pds">"</span><span class="pl-pds">"</span></span>)]
<span class="pl-k">public</span> <span class="pl-k">async</span> <span class="pl-en">Task</span>&lt;<span class="pl-en">InventoryItem</span>&gt; <span class="pl-en">AddNewItem</span>(<span class="pl-en">InventoryItem</span> <span class="pl-smi">item</span>)
{
    <span class="pl-k">using</span> (<span class="pl-k">var</span> <span class="pl-en">tx </span>= _stateManager.CreateTransaction())
    {
        <span class="pl-k">var</span> <span class="pl-en">inventoryDictionary </span>= <span class="pl-k">await</span> _stateManager.GetOrAddAsync&lt;IReliableDictionary&lt;Guid, InventoryItem&gt;&gt;(<span class="pl-s"><span class="pl-pds">"</span>inventoryDictionary<span class="pl-pds">"</span></span>);
        <span class="pl-k">if</span> (item.ItemId == Guid.Empty) item.ItemId = Guid.NewGuid();
        <span class="pl-k">await</span> inventoryDictionary.AddAsync(tx, item.ItemId, item);
        <span class="pl-k">await</span> tx.CommitAsync();
    }
    <span class="pl-k">return</span> item;
}
</pre></div>
<p>This code follows a very similar pattern to the GetItem(s) blocks discussed previously.</p>
</li>
<li>
<p>Add the methods in the block below to add support for updating inventory quantities:</p>
<div class="highlight highlight-source-cs"><pre>[HttpPost]
[Route(<span class="pl-s"><span class="pl-pds">"</span>{itemId}/addinventory/{quantity}<span class="pl-pds">"</span></span>)]
<span class="pl-k">public</span> <span class="pl-en">Task</span> <span class="pl-en">AddInventory</span>(<span class="pl-en">Guid</span> <span class="pl-smi">itemId</span>, <span class="pl-en">Int32</span> <span class="pl-smi">quantity</span>)
{
    <span class="pl-k">if</span> (quantity &lt; <span class="pl-c1">0</span>) <span class="pl-k">throw</span> <span class="pl-k">new</span> <span class="pl-en">ArgumentException</span>(<span class="pl-s"><span class="pl-pds">"</span>Quantity must be a positive number<span class="pl-pds">"</span></span>, <span class="pl-k">nameof</span>(<span class="pl-en">quantity</span>));
    <span class="pl-k">return</span> UpdateInventoryAsync(itemId, quantity);
}

[HttpPost]
[Route(<span class="pl-s"><span class="pl-pds">"</span>{itemId}/removeinventory/{quantity}<span class="pl-pds">"</span></span>)]
<span class="pl-k">public</span> <span class="pl-en">Task</span> <span class="pl-en">RemoveInventory</span>(<span class="pl-en">Guid</span> <span class="pl-smi">itemId</span>, <span class="pl-en">Int32</span> <span class="pl-smi">quantity</span>)
{
    <span class="pl-k">if</span> (quantity &lt; <span class="pl-c1">0</span>) <span class="pl-k">throw</span> <span class="pl-k">new</span> <span class="pl-en">ArgumentException</span>(<span class="pl-s"><span class="pl-pds">"</span>Quantity must be a positive number<span class="pl-pds">"</span></span>, <span class="pl-k">nameof</span>(<span class="pl-en">quantity</span>));
    <span class="pl-k">return</span> UpdateInventoryAsync(itemId, -<span class="pl-c1">1</span> * quantity);
}

<span class="pl-k">private</span> <span class="pl-k">async</span> <span class="pl-en">Task</span> <span class="pl-en">UpdateInventoryAsync</span>(<span class="pl-en">Guid</span> <span class="pl-smi">itemId</span>, <span class="pl-en">Int32</span> <span class="pl-smi">quantity</span>)
{
    <span class="pl-k">using</span> (<span class="pl-en">ITransaction</span> <span class="pl-en">tx</span> = _stateManager.CreateTransaction())
    {
        <span class="pl-c">// Use the user’s name to look up their data</span>
        <span class="pl-k">var</span> <span class="pl-en">inventoryDictionary </span>= <span class="pl-k">await</span> _stateManager.GetOrAddAsync&lt;IReliableDictionary&lt;Guid, InventoryItem&gt;&gt;(<span class="pl-s"><span class="pl-pds">"</span>inventoryDictionary<span class="pl-pds">"</span></span>);

        <span class="pl-k">var</span> <span class="pl-en">originalItem </span>= <span class="pl-k">await</span> inventoryDictionary.TryGetValueAsync(tx, itemId);
        <span class="pl-k">if</span> (originalItem.HasValue)
        {
            <span class="pl-k">var</span> <span class="pl-en">updatedItem </span>= InventoryItem.CreateCopy(originalItem.Value);
            updatedItem.InventoryCount = updatedItem.InventoryCount + quantity;
            <span class="pl-k">await</span> inventoryDictionary.TryUpdateAsync(tx, itemId, updatedItem, originalItem.Value);

            <span class="pl-k">await</span> tx.CommitAsync();
        }
    }
}
</pre></div>
<blockquote>
<p>The code in the <code>UpdateInventoryAsync</code> block is different from the code shown in the previous blocks in a subtle but important way.  Items stored in the Reliable Collections are immutable.  In order to update an <code>InventoryItem</code> to reflect the new quantities, the items first need to be duplicated.  The copy is then updated, and the original <code>InventoryItem</code> value in the dictionary is replaced with a call to <code>TryUpdateAsync</code>.</p>
</blockquote>
</li>
<li>
<p>At this point, it would be wise to build and run your Service Fabric solution in Visual Studio using the steps presented in Exercise 2.</p>
<p>The services are not yet communicating with each other, so you won't see any new behavior in the service itself, but you can use the Service Fabric Explorer to see the two services working in your application.</p>
<p>With your application running, once again right-click on the <strong>Service Fabric Local Cluster Manager</strong> icon in your Windows System Tray and select <strong>Manage Local Cluster</strong>.  Open the Applications node until you see both services running in the cluster.</p>
<p><a href="Images/addservice-check_bothservicesrunning.png" target="_blank"><img src="Images/addservice-check_bothservicesrunning.png" alt="Making Sure Both Services Are Running in the Service Fabric Explorer" style="max-width:100%;"></a></p>
<p><em>Making Sure Both Services Are Running in the Service Fabric Explorer</em></p>
<p>Once you have checked that both services are listed in the <em>Service Fabric Explorer</em>, stop debugging.</p>
</li>
</ol>
<p><a name="Exercise4"></a></p>
<h2>Exercise 4: Communicating Between Services in a Service Fabric Cluster</h2>
<p>In this exercise, you will connect the two services you have created, making requests to the <em>InventoryRepository</em> from the <em>InventoryService</em>.  This will allow you to add inventory items to the catalog, as well as increase and decrease the inventory quantity for a given item.   At the end of this exercise, you will be able to launch your application and interact with it from your Web browser.</p>
<ol>
<li>
<p>Right-click on the <strong>InventoryService</strong> project entry in the Solution Explorer.  Click on <strong>Add</strong> and then click on <strong>Existing Item</strong> in the popup menus.</p>
</li>
<li>
<p>In the <em>Add Existing Item</em> dialog, browse to the folder where this lab content is located and open the <em>Assets</em> folder.  Select the <strong>HttpCommunicationClient.cs</strong> file and click on the <strong>Add</strong> button.</p>
<p><a href="Images/communicate-add_httpommunicationclient.png" target="_blank"><img src="Images/communicate-add_httpommunicationclient.png" alt="Add the HTTPCommunicationClient File" style="max-width:100%;"></a></p>
<p><em>Add the HTTPCommunicationClient File</em></p>
</li>
<li>
<p>Right-click on the <strong>Dependencies</strong> node in the <strong>InventoryService</strong> project and then click on the <strong>Add Reference...</strong> item in the context menu.</p>
<p><a href="Images/communicate-addreference.png" target="_blank"><img src="Images/communicate-addreference.png" alt="Add a Reference in the InventoryService Project" style="max-width:100%;"></a></p>
<p><em>Add a Reference in the InventoryService Project</em></p>
</li>
<li>
<p>In the <strong>Reference Manager</strong> dialog, select the <strong>Projects</strong> node and then click the checkbox next to the <strong>InventoryCommon</strong> project entry.  Click the <strong>OK</strong> button to add the reference.</p>
</li>
<li>
<p>Open the <em>HomeController.cs</em> file from the <em>Controllers</em> folder in the <em>InventoryService</em> project.  Add the following <code>using</code> entries at the top of the file:</p>
<div class="highlight highlight-source-cs"><pre><span class="pl-k">using</span> <span class="pl-en">System.Fabric</span>;
<span class="pl-k">using</span> <span class="pl-en">System.Net.Http</span>;
<span class="pl-k">using</span> <span class="pl-en">System.Text</span>;
<span class="pl-k">using</span> <span class="pl-en">System.Threading</span>;
<span class="pl-k">using</span> <span class="pl-en">Microsoft.ServiceFabric.Services.Communication.Client</span>;
<span class="pl-k">using</span> <span class="pl-en">Microsoft.ServiceFabric.Services.Client</span>;
<span class="pl-k">using</span> <span class="pl-en">Newtonsoft.Json</span>;
<span class="pl-k">using</span> <span class="pl-en">InventoryCommon</span>;</pre></div>
</li>
<li>
<p>Scroll to the bottom of the <em>HomeController.cs</em> file and add the following helper classes just before the final curly-brace:</p>
<div class="highlight highlight-source-cs"><pre><span class="pl-k">public</span> <span class="pl-k">class</span> <span class="pl-en">ItemListViewModel</span>
{
    <span class="pl-k">public </span><span class="pl-en">IEnumerable</span>&lt;<span class="pl-en">InventoryItem</span>&gt; <span class="pl-en">InventoryItems</span> { <span class="pl-k">get</span>; <span class="pl-k">set</span>; }
    <span class="pl-k">public </span><span class="pl-en">InventoryItemType</span>? <span class="pl-en">SelectedItemType</span> { <span class="pl-k">get</span>; <span class="pl-k">set</span>; }
}

<span class="pl-k">public</span> <span class="pl-k">class</span> <span class="pl-en">InventoryQuantityViewModel</span>
{
    <span class="pl-k">public </span><span class="pl-en">Guid</span> <span class="pl-en">ItemId</span> { <span class="pl-k">get</span>; <span class="pl-k">set</span>; }
    <span class="pl-k">public </span><span class="pl-en">InventoryItemType</span> <span class="pl-en">ItemType</span> { <span class="pl-k">get</span>; <span class="pl-k">set</span>; }
    <span class="pl-k">public </span><span class="pl-en">String</span> <span class="pl-en">Display</span> { <span class="pl-k">get</span>; <span class="pl-k">set</span>; }
    <span class="pl-k">public </span><span class="pl-en">Boolean</span> <span class="pl-en">IsAdd</span> { <span class="pl-k">get</span>; <span class="pl-k">set</span>; }
    <span class="pl-k">public </span><span class="pl-en">Int32</span> <span class="pl-en">Quantity</span> { <span class="pl-k">get</span>; <span class="pl-k">set</span>; }
}</pre></div>
</li>
<li>
<p>Next, and the following field definitions at the start of the <code>HomeController</code> class:</p>
<div class="highlight highlight-source-cs"><pre><span class="pl-k">private</span> <span class="pl-k">readonly</span> <span class="pl-en">HttpCommunicationClientFactory</span> _clientFactory 
	= new <span class="pl-en">HttpCommunicationClientFactory</span>(<span class="pl-en">new</span> <span class="pl-smi">ServicePartitionResolver</span>(() =&gt; <span class="pl-k">new</span> <span class="pl-en">FabricClient</span>()));
<span class="pl-k">private</span> <span class="pl-k">readonly</span> <span class="pl-en">Uri</span> <span class="pl-en">_serviceUri</span> = <span class="pl-k">new</span> <span class="pl-en">Uri</span>(<span class="pl-pds">$"</span>{FabricRuntime.GetActivationContext().ApplicationName}<span class="pl-s">/InventoryRepository</span><span class="pl-pds">"</span>);</pre></div>
<p>These values will be used by the code in the <em>InventoryService</em> to locate and communicate with the endpoints exposed by the <em>InventoryRepository</em> service.</p>
</li>
<li>
<p>Replace the existing <code>Index</code> method with the following block of code:</p>
<div class="highlight highlight-source-cs"><pre>[HttpGet]
<span class="pl-k">public</span> <span class="pl-k">async</span> <span class="pl-en">Task</span>&lt;<span class="pl-en">IActionResult</span>&gt; <span class="pl-en">Index</span>(<span class="pl-en">InventoryItemType</span>? <span class="pl-smi">selectedItemType</span>)
{
    <span class="pl-c">// If not item type is selected, just display a blank list</span>
    <span class="pl-k">if</span> (selectedItemType == <span class="pl-c1">null</span>)
    {
        <span class="pl-k">return</span> View(<span class="pl-k">new</span> <span class="pl-en">ItemListViewModel</span> { InventoryItems = <span class="pl-k">new</span> <span class="pl-en">InventoryItem</span>[] { } });
    }

    <span class="pl-c">// An item type has been selected - retrieve its contents.</span>
    <span class="pl-k">var</span> <span class="pl-en">partitionKey </span>= <span class="pl-k">new</span> <span class="pl-en">ServicePartitionKey</span>(0);
    <span class="pl-k">var</span> <span class="pl-en">partitionClient </span>= <span class="pl-k">new</span> <span class="pl-en">ServicePartitionClient</span>&lt;HttpCommunicationClient&gt;(_clientFactory, _serviceUri, partitionKey);
    <span class="pl-k">var</span> <span class="pl-en">items </span>= <span class="pl-k">await</span> partitionClient.InvokeWithRetryAsync(async (client) =&gt;
    {
        <span class="pl-k">var</span> <span class="pl-en">response </span>= <span class="pl-k">await</span> client.HttpClient.GetAsync(<span class="pl-k">new</span> <span class="pl-en">Uri</span>(<span class="pl-pds">$"</span>{client.BaseUri}<span class="pl-s">/api/inventory</span><span class="pl-pds">"</span>));
        <span class="pl-k">if</span> (!response.IsSuccessStatusCode)
        {
            <span class="pl-k">throw</span> <span class="pl-k">new</span> <span class="pl-en">InvalidOperationException</span>(<span class="pl-pds">$"</span><span class="pl-s">Error - </span>{response.StatusCode}<span class="pl-s">: </span>{response.ReasonPhrase}<span class="pl-pds">"</span>);
        }
        
        <span class="pl-k">var</span> <span class="pl-en">responseContent </span>= <span class="pl-k">await</span> response.Content.ReadAsStringAsync();
        <span class="pl-k">var</span> <span class="pl-en">resultItems </span>= JsonConvert.DeserializeObject&lt;IEnumerable&lt;InventoryItem&gt;&gt;(<span class="pl-en">responseContent</span>);

        <span class="pl-c">// Note - filter applied client-side for demo purposes only.</span>
        <span class="pl-k">return</span> resultItems.Where(x =&gt; x.ItemType == selectedItemType);
                        
    }, CancellationToken.None);

    <span class="pl-k">var</span> <span class="pl-en">viewModel </span>= <span class="pl-k">new</span> <span class="pl-en">ItemListViewModel</span>
    {
        InventoryItems = items,
        SelectedItemType = selectedItemType
    };
    <span class="pl-k">return</span> View(viewModel);
}
</pre></div>
<p>This version of the <code>Index</code> method first checks to see if an <em>InventoryItemType</em> selection has been made.  The user interface in this application will display the inventory items based on the currently selected item type.  If no selection has been made, it simply passes an empty list to the view for display.</p>
<p>If a selection has been made, a call is made to the InventoryRepository to retrieve the available catalog items in that category.  To make the request, an instance of the <code>ServicePatitionClient</code> class is used via a call to the <code>InvokeWithRetryAsync</code> method it provides.  The <code>ServicePartitionClient</code> class simpliefies access with stateful services in Service Fabric by resolving partition endpoint addresses for you.  It also provides the <code>InvokeWithRetryAsync</code> method which, as the name suggests, further facilitates calling the indicated endpoint by managing retries in the event that transient errors occur.</p>
<p>The call is made to the inventory endpoint, and if a valid reponse code is received, the response JSON is converted into a list of <code>InventoryItem</code>s.  Finally, the returned list is filtered, and then this is colected and passed to the view for display.</p>
<blockquote>
<p>Note that the filtering of the returned list to a given item type on the client end of the request is not a pattern you would use in production, but is instead done for simplicity in this Exercise.  In the next exercise you will see how you can eliminate this step by using the Partitioning support in Service Fabric.</p>
</blockquote>
</li>
<li>
<p>Now open the <em>Views</em> folder in the project, then open the <em>Index.html</em> file from the <em>Home</em> subfolder under the <em>Views</em> folder.  Replace its content with the code block below:</p>
<div class="highlight highlight-text-html-basic"><pre>@model InventoryService.Controllers.ItemListViewModel

@{
    ViewData["Title"] = "Inventory List";
}

&lt;<span class="pl-ent">div</span> <span class="pl-e">class</span>=<span class="pl-s"><span class="pl-pds">"</span>row<span class="pl-pds">"</span></span> <span class="pl-e">style</span>=<span class="pl-s"><span class="pl-pds">"</span>padding-bottom: 20px; padding-top: 20px;<span class="pl-pds">"</span></span>&gt;
    &lt;<span class="pl-ent">div</span> <span class="pl-e">class</span>=<span class="pl-s"><span class="pl-pds">"</span>col-sm-12<span class="pl-pds">"</span></span>&gt;
        &lt;<span class="pl-ent">form</span> <span class="pl-e">method</span>=<span class="pl-s"><span class="pl-pds">"</span>get<span class="pl-pds">"</span></span> <span class="pl-e">class</span>=<span class="pl-s"><span class="pl-pds">"</span>form-inline<span class="pl-pds">"</span></span>&gt;
            &lt;<span class="pl-ent">div</span> <span class="pl-e">class</span>=<span class="pl-s"><span class="pl-pds">"</span>form-group<span class="pl-pds">"</span></span>&gt;
                &lt;<span class="pl-ent">label</span> <span class="pl-e">asp-for</span>=<span class="pl-s"><span class="pl-pds">"</span>SelectedItemType<span class="pl-pds">"</span></span>&gt;&lt;/<span class="pl-ent">label</span>&gt;
                &lt;<span class="pl-ent">select</span> <span class="pl-e">asp-for</span>=<span class="pl-s"><span class="pl-pds">"</span>SelectedItemType<span class="pl-pds">"</span></span>
                        <span class="pl-e">asp-items</span>=<span class="pl-s"><span class="pl-pds">"</span>@(new SelectList(Enum.GetNames(typeof(InventoryCommon.InventoryItemType))))<span class="pl-pds">"</span></span>
                        <span class="pl-e">class</span>=<span class="pl-s"><span class="pl-pds">"</span>form-control<span class="pl-pds">"</span></span>&gt;
                    &lt;<span class="pl-ent">option</span>&gt;Choose an item type&lt;/<span class="pl-ent">option</span>&gt;
                &lt;/<span class="pl-ent">select</span>&gt;
            &lt;/<span class="pl-ent">div</span>&gt;
            &lt;<span class="pl-ent">button</span> <span class="pl-e">type</span>=<span class="pl-s"><span class="pl-pds">"</span>submit<span class="pl-pds">"</span></span> <span class="pl-e">class</span>=<span class="pl-s"><span class="pl-pds">"</span>btn btn-primary<span class="pl-pds">"</span></span>&gt;Select&lt;/<span class="pl-ent">button</span>&gt;
        &lt;/<span class="pl-ent">form</span>&gt;
    &lt;/<span class="pl-ent">div</span>&gt;
&lt;/<span class="pl-ent">div</span>&gt;

&lt;<span class="pl-ent">div</span> <span class="pl-e">class</span>=<span class="pl-s"><span class="pl-pds">"</span>row<span class="pl-pds">"</span></span>&gt;
    &lt;<span class="pl-ent">div</span> <span class="pl-e">class</span>=<span class="pl-s"><span class="pl-pds">"</span>col-sm-12<span class="pl-pds">"</span></span>&gt;
        &lt;<span class="pl-ent">div</span> <span class="pl-e">class</span>=<span class="pl-s"><span class="pl-pds">"</span>table-responsive<span class="pl-pds">"</span></span>&gt;
            &lt;<span class="pl-ent">table</span> <span class="pl-e">class</span>=<span class="pl-s"><span class="pl-pds">"</span>table table-condensed table-bordered table-responsive table-hover<span class="pl-pds">"</span></span>&gt;
                &lt;<span class="pl-ent">thead</span>&gt;
                    &lt;<span class="pl-ent">tr</span>&gt;
                        &lt;<span class="pl-ent">th</span>&gt;&lt;<span class="pl-ent">span</span>&gt;Item Type&lt;/<span class="pl-ent">span</span>&gt;&lt;/<span class="pl-ent">th</span>&gt;
                        &lt;<span class="pl-ent">th</span>&gt;&lt;<span class="pl-ent">span</span>&gt;Name&lt;/<span class="pl-ent">span</span>&gt;&lt;/<span class="pl-ent">th</span>&gt;
                        &lt;<span class="pl-ent">th</span>&gt;&lt;<span class="pl-ent">span</span>&gt;Count&lt;/<span class="pl-ent">span</span>&gt;&lt;/<span class="pl-ent">th</span>&gt;
                        &lt;<span class="pl-ent">th</span>&gt;&lt;<span class="pl-ent">span</span>&gt;Add/Remove&lt;/<span class="pl-ent">span</span>&gt;&lt;/<span class="pl-ent">th</span>&gt;
                    &lt;/<span class="pl-ent">tr</span>&gt;
                &lt;/<span class="pl-ent">thead</span>&gt;
                &lt;<span class="pl-ent">tbody</span>&gt;
                    @foreach (var inventoryItem in Model.InventoryItems)
                    {
                        &lt;<span class="pl-ent">tr</span>&gt;
                            &lt;<span class="pl-ent">td</span>&gt;&lt;<span class="pl-ent">span</span>&gt;@inventoryItem.ItemType&lt;/<span class="pl-ent">span</span>&gt;&lt;/<span class="pl-ent">td</span>&gt;
                            &lt;<span class="pl-ent">td</span>&gt;&lt;<span class="pl-ent">span</span>&gt;@inventoryItem.Name&lt;/<span class="pl-ent">span</span>&gt;&lt;/<span class="pl-ent">td</span>&gt;
                            &lt;<span class="pl-ent">td</span>&gt;&lt;<span class="pl-ent">span</span>&gt;@inventoryItem.InventoryCount&lt;/<span class="pl-ent">span</span>&gt;&lt;/<span class="pl-ent">td</span>&gt;
                            &lt;<span class="pl-ent">td</span>&gt;
                                &lt;<span class="pl-ent">a</span> <span class="pl-e">asp-action</span>=<span class="pl-s"><span class="pl-pds">"</span>AddInventory<span class="pl-pds">"</span></span> 
                                   <span class="pl-e">asp-route-itemId</span>=<span class="pl-s"><span class="pl-pds">"</span>@inventoryItem.ItemId<span class="pl-pds">"</span></span> 
                                   <span class="pl-e">asp-route-selectedItemType</span>=<span class="pl-s"><span class="pl-pds">"</span>@inventoryItem.ItemType<span class="pl-pds">"</span></span>&gt;
                                    &lt;<span class="pl-ent">span</span>&gt;Increase&lt;/<span class="pl-ent">span</span>&gt;
                                &lt;/<span class="pl-ent">a</span>&gt;
                                <span class="pl-c1">&amp;nbsp;</span>|<span class="pl-c1">&amp;nbsp;</span>
                                &lt;<span class="pl-ent">a</span> <span class="pl-e">asp-action</span>=<span class="pl-s"><span class="pl-pds">"</span>RemoveInventory<span class="pl-pds">"</span></span> 
                                   <span class="pl-e">asp-route-itemId</span>=<span class="pl-s"><span class="pl-pds">"</span>@inventoryItem.ItemId<span class="pl-pds">"</span></span> 
                                   <span class="pl-e">asp-route-selectedItemType</span>=<span class="pl-s"><span class="pl-pds">"</span>@inventoryItem.ItemType<span class="pl-pds">"</span></span>&gt;
                                    &lt;<span class="pl-ent">span</span>&gt;Decrease&lt;/<span class="pl-ent">span</span>&gt;
                                &lt;/<span class="pl-ent">a</span>&gt;
                            &lt;/<span class="pl-ent">td</span>&gt;
                        &lt;/<span class="pl-ent">tr</span>&gt;
                    }
                &lt;/<span class="pl-ent">tbody</span>&gt;
            &lt;/<span class="pl-ent">table</span>&gt;
        &lt;/<span class="pl-ent">div</span>&gt;
    &lt;/<span class="pl-ent">div</span>&gt;
&lt;/<span class="pl-ent">div</span>&gt;
&lt;<span class="pl-ent">div</span> <span class="pl-e">class</span>=<span class="pl-s"><span class="pl-pds">"</span>row<span class="pl-pds">"</span></span>&gt;
    &lt;<span class="pl-ent">div</span> <span class="pl-e">class</span>=<span class="pl-s"><span class="pl-pds">"</span>col-sm-12<span class="pl-pds">"</span></span>&gt;
        &lt;<span class="pl-ent">a</span> <span class="pl-e">asp-action</span>=<span class="pl-s"><span class="pl-pds">"</span>AddNewInventoryItem<span class="pl-pds">"</span></span> <span class="pl-e">asp-route-itemType</span>=<span class="pl-s"><span class="pl-pds">"</span>@Model.SelectedItemType<span class="pl-pds">"</span></span> 
           <span class="pl-e">class</span>=<span class="pl-s"><span class="pl-pds">"</span>btn btn-primary @(Model.SelectedItemType == null ? <span class="pl-pds">"</span></span><span class="pl-e">disabled</span><span class="pl-s"><span class="pl-pds">"</span> : <span class="pl-pds">"</span><span class="pl-pds">"</span>)<span class="pl-pds">"</span></span>&gt;
            Add New Product
        &lt;/<span class="pl-ent">a</span>&gt;
    &lt;/<span class="pl-ent">div</span>&gt;
&lt;/<span class="pl-ent">div</span>&gt;</pre></div>
<p>This markup provides the user interface elements for selecting the current inventory item types, the table where the items are displayed, and a button to add a new inventory item to the catalog.</p>
</li>
<li>
<p>Return to the <em>HomeController.cs file</em>.  After the end of the <code>Index</code> method, add the following block of code:</p>
<div class="highlight highlight-source-cs"><pre>[HttpGet]
<span class="pl-k">public</span> <span class="pl-en">IActionResult</span> <span class="pl-en">AddNewInventoryItem</span>(<span class="pl-en">InventoryItemType</span> <span class="pl-smi">itemType</span>)
{
    <span class="pl-k">var</span> <span class="pl-en">newItem </span>= <span class="pl-k">new</span> <span class="pl-en">InventoryItem</span> { ItemType = itemType };
    <span class="pl-k">return</span> View(newItem);
}

[HttpPost]
<span class="pl-k">public</span> <span class="pl-k">async</span> <span class="pl-en">Task</span>&lt;<span class="pl-en">IActionResult</span>&gt; <span class="pl-en">AddNewInventoryItem</span>(<span class="pl-en">InventoryItem</span> <span class="pl-smi">newItem</span>)
{
    <span class="pl-k">var</span> <span class="pl-en">partitionKey </span>= <span class="pl-k">new</span> <span class="pl-en">ServicePartitionKey</span>(0);
    <span class="pl-k">var</span> <span class="pl-en">partitionClient </span>= <span class="pl-k">new</span> <span class="pl-en">ServicePartitionClient</span>&lt;HttpCommunicationClient&gt;(_clientFactory, _serviceUri, partitionKey);
    <span class="pl-k">var</span> <span class="pl-en">results </span>= <span class="pl-k">await</span> partitionClient.InvokeWithRetryAsync(async (client) =&gt;
    {
        <span class="pl-k">var</span> <span class="pl-en">newItemContent </span>= <span class="pl-k">new</span> <span class="pl-en">StringContent</span>(JsonConvert.SerializeObject(newItem), Encoding.UTF8, <span class="pl-s"><span class="pl-pds">"</span>application/json<span class="pl-pds">"</span></span>);
        <span class="pl-k">var</span> <span class="pl-en">response </span>= <span class="pl-k">await</span> client.HttpClient.PostAsync(<span class="pl-k">new</span> <span class="pl-en">Uri</span>(<span class="pl-pds">$"</span>{client.BaseUri}<span class="pl-s">/api/inventory</span><span class="pl-pds">"</span>), newItemContent);
        <span class="pl-k">if</span> (!response.IsSuccessStatusCode)
        {
            <span class="pl-k">throw</span> <span class="pl-k">new</span> <span class="pl-en">InvalidOperationException</span>(<span class="pl-pds">$"</span><span class="pl-s">Error - </span>{response.StatusCode}<span class="pl-s">: </span>{response.ReasonPhrase}<span class="pl-pds">"</span>);
        }

        <span class="pl-k">var</span> <span class="pl-en">responseContent </span>= <span class="pl-k">await</span> response.Content.ReadAsStringAsync();
        <span class="pl-k">return</span> JsonConvert.DeserializeObject&lt;InventoryItem&gt;(<span class="pl-en">responseContent</span>);

    }, CancellationToken.None);

    <span class="pl-k">return</span> RedirectToAction(<span class="pl-s"><span class="pl-pds">"</span>Index<span class="pl-pds">"</span></span>, new { SelectedItemType = newItem.ItemType });
}</pre></div>
<p>These two methods handle adding a new inventory item to the catalog.  The first <code>AddInventoryItem</code> method simply sets up a blank item with the currently selected inventory item type.</p>
<p>The second method uses the same <code>ServicePartitionClient</code> class and retry approach to communicate with the InventoryService endpoint that supports adding a new inventory item.  If the item is successfully added, the browser is redirected to the home page that includes the inventory table with the current inventory type value pre-selected.</p>
</li>
<li>
<p>Right-click on the <em>Home</em> subfolder of the <em>Views</em> folder in the project.  Click on <strong>Add</strong> and then on <strong>New Item...</strong> in the context menu.</p>
<p><a href="Images/communicate-add_newitemtoviewshomefolder.png" target="_blank"><img src="Images/communicate-add_newitemtoviewshomefolder.png" alt="Add New Item to the Home View Folder" style="max-width:100%;"></a></p>
<p><em>Add New Item to the Home View Folder</em></p>
</li>
<li>
<p>In the Add New Item - InventoryService dialog, click on <strong>MVC View Page</strong>, name the file <strong>AddNewInventoryItem.cshtml</strong>, and then click on the <strong>Add</strong> button to add the file.</p>
<p><a href="Images/communicate-add_newinventoryitemview.png" target="_blank"><img src="Images/communicate-add_newinventoryitemview.png" alt="Add the AddNewInventoryItem View" style="max-width:100%;"></a></p>
<p><em>Add the AddNewInventoryItem View</em></p>
</li>
<li>
<p>Replace the markup in the new view file with the following block:</p>
<div class="highlight highlight-text-html-basic"><pre>@model InventoryCommon.InventoryItem

@{
    ViewData["Title"] = "Create Inventory Item";
}

&lt;<span class="pl-ent">div</span> <span class="pl-e">class</span>=<span class="pl-s"><span class="pl-pds">"</span>row<span class="pl-pds">"</span></span>&gt;
    &lt;<span class="pl-ent">div</span> <span class="pl-e">class</span>=<span class="pl-s"><span class="pl-pds">"</span>col-sm-12<span class="pl-pds">"</span></span>&gt;
        &lt;<span class="pl-ent">form</span> <span class="pl-e">asp-action</span>=<span class="pl-s"><span class="pl-pds">"</span>AddNewInventoryItem<span class="pl-pds">"</span></span> <span class="pl-e">method</span>=<span class="pl-s"><span class="pl-pds">"</span>post<span class="pl-pds">"</span></span>&gt;
            &lt;<span class="pl-ent">div</span> <span class="pl-e">class</span>=<span class="pl-s"><span class="pl-pds">"</span>form-group<span class="pl-pds">"</span></span>&gt;
                &lt;<span class="pl-ent">label</span> <span class="pl-e">asp-for</span>=<span class="pl-s"><span class="pl-pds">"</span>Name<span class="pl-pds">"</span></span>&gt;&lt;/<span class="pl-ent">label</span>&gt;
                &lt;<span class="pl-ent">input</span> <span class="pl-e">asp-for</span>=<span class="pl-s"><span class="pl-pds">"</span>Name<span class="pl-pds">"</span></span> <span class="pl-e">class</span>=<span class="pl-s"><span class="pl-pds">"</span>form-control<span class="pl-pds">"</span></span> <span class="pl-e">placeholder</span>=<span class="pl-s"><span class="pl-pds">"</span>Name<span class="pl-pds">"</span></span> /&gt;
            &lt;/<span class="pl-ent">div</span>&gt;
            &lt;<span class="pl-ent">div</span> <span class="pl-e">class</span>=<span class="pl-s"><span class="pl-pds">"</span>form-group<span class="pl-pds">"</span></span>&gt;
                &lt;<span class="pl-ent">label</span> <span class="pl-e">asp-for</span>=<span class="pl-s"><span class="pl-pds">"</span>ItemType<span class="pl-pds">"</span></span>&gt;&lt;/<span class="pl-ent">label</span>&gt;
                &lt;<span class="pl-ent">select</span> <span class="pl-e">asp-for</span>=<span class="pl-s"><span class="pl-pds">"</span>ItemType<span class="pl-pds">"</span></span> 
                        <span class="pl-e">asp-items</span>=<span class="pl-s"><span class="pl-pds">"</span>@(new SelectList(Enum.GetNames(typeof(InventoryCommon.InventoryItemType))))<span class="pl-pds">"</span></span> 
                        <span class="pl-e">class</span>=<span class="pl-s"><span class="pl-pds">"</span>form-control<span class="pl-pds">"</span></span>&gt;
                    &lt;<span class="pl-ent">option</span>&gt;Choose an item type&lt;/<span class="pl-ent">option</span>&gt;
                &lt;/<span class="pl-ent">select</span>&gt;
            &lt;/<span class="pl-ent">div</span>&gt;
            &lt;<span class="pl-ent">div</span>&gt;
                &lt;<span class="pl-ent">button</span> <span class="pl-e">type</span>=<span class="pl-s"><span class="pl-pds">"</span>submit<span class="pl-pds">"</span></span> <span class="pl-e">class</span>=<span class="pl-s"><span class="pl-pds">"</span>btn btn-primary<span class="pl-pds">"</span></span>&gt;Add Inventory Item&lt;/<span class="pl-ent">button</span>&gt;
                &lt;<span class="pl-ent">a</span> <span class="pl-e">asp-action</span>=<span class="pl-s"><span class="pl-pds">"</span>index<span class="pl-pds">"</span></span> <span class="pl-e">asp-route-selectedItemType</span>=<span class="pl-s"><span class="pl-pds">"</span>@(Model.ItemType)<span class="pl-pds">"</span></span> <span class="pl-e">class</span>=<span class="pl-s"><span class="pl-pds">"</span>btn btn-default<span class="pl-pds">"</span></span>&gt;Cancel&lt;/<span class="pl-ent">a</span>&gt;
            &lt;/<span class="pl-ent">div</span>&gt;
        &lt;/<span class="pl-ent">form</span>&gt;
    &lt;/<span class="pl-ent">div</span>&gt;
&lt;/<span class="pl-ent">div</span>&gt;</pre></div>
<p>This markup provides the user interface elements needed to build the new inventory item, and calls the creation method when the <em>Add Inventory Item</em> button is clicked.</p>
</li>
<li>
<p>Return again to the <em>HomeController.cs file</em>.  After the end of the second <code>AddNewInventoryItem</code> method, add the following block of code:</p>
<div class="highlight highlight-source-cs"><pre>[HttpGet]
<span class="pl-k">public</span> <span class="pl-k">async</span> <span class="pl-en">Task</span>&lt;<span class="pl-en">IActionResult</span>&gt; <span class="pl-en">AddInventory</span>(<span class="pl-en">Guid</span> <span class="pl-smi">itemId</span>, <span class="pl-en">InventoryItemType</span> <span class="pl-smi">selectedItemType</span>)
{
    <span class="pl-k">var</span> <span class="pl-en">partitionKey </span>= <span class="pl-k">new</span> <span class="pl-en">ServicePartitionKey</span>(0);
    <span class="pl-k">var</span> <span class="pl-en">partitionClient </span>= <span class="pl-k">new</span> <span class="pl-en">ServicePartitionClient</span>&lt;HttpCommunicationClient&gt;(_clientFactory, _serviceUri, partitionKey);
    <span class="pl-k">var</span> <span class="pl-en">item </span>= <span class="pl-k">await</span> partitionClient.InvokeWithRetryAsync(async (client) =&gt;
    {
        <span class="pl-k">var</span> <span class="pl-en">response </span>= <span class="pl-k">await</span> client.HttpClient.GetAsync(<span class="pl-k">new</span> <span class="pl-en">Uri</span>(<span class="pl-pds">$"</span>{client.BaseUri}<span class="pl-s">/api/inventory/</span>{itemId}<span class="pl-pds">"</span>));
        <span class="pl-k">if</span> (!response.IsSuccessStatusCode)
        {
            <span class="pl-k">throw</span> <span class="pl-k">new</span> <span class="pl-en">InvalidOperationException</span>(<span class="pl-pds">$"</span><span class="pl-s">Error - </span>{response.StatusCode}<span class="pl-s">: </span>{response.ReasonPhrase}<span class="pl-pds">"</span>);
        }

        <span class="pl-k">var</span> <span class="pl-en">responseContent </span>= <span class="pl-k">await</span> response.Content.ReadAsStringAsync();
        <span class="pl-k">return</span> JsonConvert.DeserializeObject&lt;InventoryItem&gt;(<span class="pl-en">responseContent</span>);

    }, CancellationToken.None);

    <span class="pl-k">var</span> <span class="pl-en">viewModel </span>= <span class="pl-k">new</span> <span class="pl-en">InventoryQuantityViewModel</span>
    {
        ItemId = item.ItemId,
        ItemType = item.ItemType,
        Display = <span class="pl-pds">$"</span>{item.Name}<span class="pl-s"> (</span>{item.ItemType}<span class="pl-s">)</span><span class="pl-pds">"</span>,
        IsAdd = <span class="pl-c1">true</span>,
        Quantity = <span class="pl-c1">1</span>
    };
    <span class="pl-k">return</span> View(<span class="pl-s"><span class="pl-pds">"</span>UpdateInventoryQuantity<span class="pl-pds">"</span></span>, viewModel);
}

[HttpPost]
<span class="pl-k">public</span> <span class="pl-k">async</span> <span class="pl-en">Task</span>&lt;<span class="pl-en">IActionResult</span>&gt; <span class="pl-en">AddInventory</span>(<span class="pl-en">InventoryQuantityViewModel</span> <span class="pl-smi">viewModel</span>)
{
    <span class="pl-k">var</span> <span class="pl-en">partitionKey </span>= <span class="pl-k">new</span> <span class="pl-en">ServicePartitionKey</span>(0);
    <span class="pl-k">var</span> <span class="pl-en">partitionClient </span>= <span class="pl-k">new</span> <span class="pl-en">ServicePartitionClient</span>&lt;HttpCommunicationClient&gt;(_clientFactory, _serviceUri, partitionKey);
    <span class="pl-k">await</span> partitionClient.InvokeWithRetryAsync(async (client) =&gt;
    {
        <span class="pl-k">var</span> <span class="pl-en">uri </span>= <span class="pl-k">new</span> <span class="pl-en">Uri</span>(<span class="pl-pds">$"</span>{client.BaseUri}<span class="pl-s">/api/inventory/</span>{viewModel.ItemId}<span class="pl-s">/addinventory/</span>{viewModel.Quantity}<span class="pl-pds">"</span>);
        <span class="pl-k">var</span> <span class="pl-en">response </span>= <span class="pl-k">await</span> client.HttpClient.PostAsync(uri, <span class="pl-c1">null</span>);
        <span class="pl-k">if</span> (!response.IsSuccessStatusCode)
        {
            <span class="pl-k">throw</span> <span class="pl-k">new</span> <span class="pl-en">InvalidOperationException</span>(<span class="pl-pds">$"</span><span class="pl-s">Error - </span>{response.StatusCode}<span class="pl-s">: </span>{response.ReasonPhrase}<span class="pl-pds">"</span>);
        }

        <span class="pl-k">return</span>;
    }, CancellationToken.None);

    <span class="pl-k">return</span> RedirectToAction(<span class="pl-s"><span class="pl-pds">"</span>Index<span class="pl-pds">"</span></span>, new { SelectedItemType = viewModel.ItemType });
}</pre></div>
<p>This code adds a pair of <code>AddInventory</code> methods whose purpose and implementation are very similar to the code for the <code>AddNewInventoryItem</code> methods.</p>
</li>
<li>
<p>Add the following block of code after the code for the <code>AddInventory</code> methods that you just added:</p>
<div class="highlight highlight-source-cs"><pre>[HttpGet]
<span class="pl-k">public</span> <span class="pl-k">async</span> <span class="pl-en">Task</span>&lt;<span class="pl-en">IActionResult</span>&gt; <span class="pl-en">RemoveInventory</span>(<span class="pl-en">Guid</span> <span class="pl-smi">itemId</span>, <span class="pl-en">InventoryItemType</span> <span class="pl-smi">selectedItemType</span>)
{
    <span class="pl-k">var</span> <span class="pl-en">partitionKey </span>= <span class="pl-k">new</span> <span class="pl-en">ServicePartitionKey</span>(0);
    <span class="pl-k">var</span> <span class="pl-en">partitionClient </span>= <span class="pl-k">new</span> <span class="pl-en">ServicePartitionClient</span>&lt;HttpCommunicationClient&gt;(_clientFactory, _serviceUri, partitionKey);
    <span class="pl-k">var</span> <span class="pl-en">item </span>= <span class="pl-k">await</span> partitionClient.InvokeWithRetryAsync(async (client) =&gt;
    {
        <span class="pl-k">var</span> <span class="pl-en">response </span>= <span class="pl-k">await</span> client.HttpClient.GetAsync(<span class="pl-k">new</span> <span class="pl-en">Uri</span>(<span class="pl-pds">$"</span>{client.BaseUri}<span class="pl-s">/api/inventory/</span>{itemId}<span class="pl-pds">"</span>));
        <span class="pl-k">if</span> (!response.IsSuccessStatusCode)
        {
            <span class="pl-k">throw</span> <span class="pl-k">new</span> <span class="pl-en">InvalidOperationException</span>(<span class="pl-pds">$"</span><span class="pl-s">Error - </span>{response.StatusCode}<span class="pl-s">: </span>{response.ReasonPhrase}<span class="pl-pds">"</span>);
        }

        <span class="pl-k">var</span> <span class="pl-en">responseContent </span>= <span class="pl-k">await</span> response.Content.ReadAsStringAsync();
        <span class="pl-k">return</span> JsonConvert.DeserializeObject&lt;InventoryItem&gt;(<span class="pl-en">responseContent</span>);

    }, CancellationToken.None);

    <span class="pl-k">var</span> <span class="pl-en">viewModel </span>= <span class="pl-k">new</span> <span class="pl-en">InventoryQuantityViewModel</span>
    {
        ItemId = item.ItemId,
        ItemType = item.ItemType,
        Display = <span class="pl-pds">$"</span>{item.Name}<span class="pl-s"> (</span>{item.ItemType}<span class="pl-s">)</span><span class="pl-pds">"</span>,
        IsAdd = <span class="pl-c1">false</span>,
        Quantity = <span class="pl-c1">1</span>
    };
    <span class="pl-k">return</span> View(<span class="pl-s"><span class="pl-pds">"</span>UpdateInventoryQuantity<span class="pl-pds">"</span></span>, viewModel);
}

[HttpPost]
<span class="pl-k">public</span> <span class="pl-k">async</span> <span class="pl-en">Task</span>&lt;<span class="pl-en">IActionResult</span>&gt; <span class="pl-en">RemoveInventory</span>(<span class="pl-en">InventoryQuantityViewModel</span> <span class="pl-smi">viewModel</span>)
{
    <span class="pl-k">var</span> <span class="pl-en">partitionKey </span>= <span class="pl-k">new</span> <span class="pl-en">ServicePartitionKey</span>(0);
    <span class="pl-k">var</span> <span class="pl-en">partitionClient </span>= <span class="pl-k">new</span> <span class="pl-en">ServicePartitionClient</span>&lt;HttpCommunicationClient&gt;(_clientFactory, _serviceUri, partitionKey);
    <span class="pl-k">await</span> partitionClient.InvokeWithRetryAsync(async (client) =&gt;
    {
        <span class="pl-k">var</span> <span class="pl-en">uri </span>= <span class="pl-k">new</span> <span class="pl-en">Uri</span>(<span class="pl-pds">$"</span>{client.BaseUri}<span class="pl-s">/api/inventory/</span>{viewModel.ItemId}<span class="pl-s">/removeinventory/</span>{viewModel.Quantity}<span class="pl-pds">"</span>);
        <span class="pl-k">var</span> <span class="pl-en">response </span>= <span class="pl-k">await</span> client.HttpClient.PostAsync(uri, <span class="pl-c1">null</span>);
        <span class="pl-k">if</span> (!response.IsSuccessStatusCode)
        {
            <span class="pl-k">throw</span> <span class="pl-k">new</span> <span class="pl-en">InvalidOperationException</span>(<span class="pl-pds">$"</span><span class="pl-s">Error - </span>{response.StatusCode}<span class="pl-s">: </span>{response.ReasonPhrase}<span class="pl-pds">"</span>);
        }

        <span class="pl-k">return</span>;
    }, CancellationToken.None);

    <span class="pl-k">return</span> RedirectToAction(<span class="pl-s"><span class="pl-pds">"</span>Index<span class="pl-pds">"</span></span>, new { SelectedItemType = viewModel.ItemType });
}</pre></div>
<p>This will add the complementary <code>RemoveInventory</code> methods.</p>
</li>
<li>
<p>Finally, following the steps you used to add the <code>AddNewInventoryItem.cshtml</code> view file, add a new <code>UpdateInventoryQuantity.cshtml</code> view file.  Replace the default markup it contains with the following:</p>
<div class="highlight highlight-text-html-basic"><pre>@model InventoryService.Controllers.InventoryQuantityViewModel

@{
    ViewData["Title"] = Model.IsAdd ? "Add Inventory" : "Remove Inventory";
}

&lt;<span class="pl-ent">div</span> <span class="pl-e">class</span>=<span class="pl-s"><span class="pl-pds">"</span>row<span class="pl-pds">"</span></span>&gt;
    &lt;<span class="pl-ent">div</span> <span class="pl-e">class</span>=<span class="pl-s"><span class="pl-pds">"</span>col-sm-12<span class="pl-pds">"</span></span>&gt;
        &lt;<span class="pl-ent">form</span> <span class="pl-e">asp-action</span>=<span class="pl-s">@(Model.IsAdd</span> ? <span class="pl-s"><span class="pl-pds">"</span>AddInventory<span class="pl-pds">"</span></span> : <span class="pl-s"><span class="pl-pds">"</span>RemoveInventory<span class="pl-pds">"</span></span>) <span class="pl-e">method</span>=<span class="pl-s"><span class="pl-pds">"</span>post<span class="pl-pds">"</span></span>&gt;
            &lt;<span class="pl-ent">input</span> <span class="pl-e">asp-for</span>=<span class="pl-s"><span class="pl-pds">"</span>ItemId<span class="pl-pds">"</span></span> <span class="pl-e">type</span>=<span class="pl-s"><span class="pl-pds">"</span>hidden<span class="pl-pds">"</span></span> /&gt;
            &lt;<span class="pl-ent">input</span> <span class="pl-e">asp-for</span>=<span class="pl-s"><span class="pl-pds">"</span>ItemType<span class="pl-pds">"</span></span> <span class="pl-e">type</span>=<span class="pl-s"><span class="pl-pds">"</span>hidden<span class="pl-pds">"</span></span> /&gt;
            &lt;<span class="pl-ent">input</span> <span class="pl-e">asp-for</span>=<span class="pl-s"><span class="pl-pds">"</span>IsAdd<span class="pl-pds">"</span></span> <span class="pl-e">type</span>=<span class="pl-s"><span class="pl-pds">"</span>hidden<span class="pl-pds">"</span></span>/&gt;

            &lt;<span class="pl-ent">div</span> <span class="pl-e">class</span>=<span class="pl-s"><span class="pl-pds">"</span>form-group<span class="pl-pds">"</span></span>&gt;
                &lt;<span class="pl-ent">label</span>&gt;Item:&lt;/<span class="pl-ent">label</span>&gt;
                &lt;<span class="pl-ent">input</span> <span class="pl-e">asp-for</span>=<span class="pl-s"><span class="pl-pds">"</span>Display<span class="pl-pds">"</span></span> <span class="pl-e">class</span>=<span class="pl-s"><span class="pl-pds">"</span>form-control<span class="pl-pds">"</span></span> <span class="pl-e">placeholder</span>=<span class="pl-s"><span class="pl-pds">"</span>Name<span class="pl-pds">"</span></span> <span class="pl-e">readonly</span>/&gt;
            &lt;/<span class="pl-ent">div</span>&gt;
            &lt;<span class="pl-ent">div</span> <span class="pl-e">class</span>=<span class="pl-s"><span class="pl-pds">"</span>form-group<span class="pl-pds">"</span></span>&gt;
                &lt;<span class="pl-ent">label</span> <span class="pl-e">asp-for</span>=<span class="pl-s"><span class="pl-pds">"</span>Quantity<span class="pl-pds">"</span></span>&gt;&lt;/<span class="pl-ent">label</span>&gt;
                &lt;<span class="pl-ent">input</span> <span class="pl-e">asp-for</span>=<span class="pl-s"><span class="pl-pds">"</span>Quantity<span class="pl-pds">"</span></span> <span class="pl-e">type</span>=<span class="pl-s"><span class="pl-pds">"</span>number<span class="pl-pds">"</span></span> <span class="pl-e">class</span>=<span class="pl-s"><span class="pl-pds">"</span>form-control<span class="pl-pds">"</span></span>/&gt;
            &lt;/<span class="pl-ent">div</span>&gt;
            &lt;<span class="pl-ent">div</span>&gt;
                &lt;<span class="pl-ent">button</span> <span class="pl-e">type</span>=<span class="pl-s"><span class="pl-pds">"</span>submit<span class="pl-pds">"</span></span> <span class="pl-e">class</span>=<span class="pl-s"><span class="pl-pds">"</span>btn btn-primary<span class="pl-pds">"</span></span>&gt;@(Model.IsAdd ? "Add Inventory" : "Remove Inventory")&lt;/<span class="pl-ent">button</span>&gt;
                &lt;<span class="pl-ent">a</span> <span class="pl-e">asp-action</span>=<span class="pl-s"><span class="pl-pds">"</span>index<span class="pl-pds">"</span></span> <span class="pl-e">class</span>=<span class="pl-s"><span class="pl-pds">"</span>btn btn-default<span class="pl-pds">"</span></span>&gt;Cancel&lt;/<span class="pl-ent">a</span>&gt;
            &lt;/<span class="pl-ent">div</span>&gt;
        &lt;/<span class="pl-ent">form</span>&gt;
    &lt;/<span class="pl-ent">div</span>&gt;
&lt;/<span class="pl-ent">div</span>&gt;</pre></div>
<p>This markup defines a form that you can use to either increase or deecrease the inventory quantity for a given inventory item.</p>
</li>
<li>
<p>At this point, your service Fabric inventory application should be ready to go, hosting both user interface and repository services.  Like you did in Exercise 2, start debugging the application by clicking on the <strong>Start</strong> button in Visual Studio 2017.  This will once again deploy your Service Fabric application to your local Service Fabric cluster and then open your default Web browser to your service's URL.</p>
<p><a href="Images/communicate-run_firstapprun.png" target="_blank"><img src="Images/communicate-run_firstapprun.png" alt="Initial Application Display" style="max-width:100%;"></a></p>
<p><em>Initial Application Display</em></p>
</li>
<li>
<p>Click on the <strong>SelectedItemType</strong> dropdown and select <strong>HeatingCooling</strong>, then click on the <strong>Select</strong> button.</p>
</li>
<li>
<p>Now that you have an inventory type selected, you can start adding some inventory.  Click on the <strong>Add New Product</strong> button and complete the new inventory item form:</p>
<ul>
<li>Set the <em>Name</em> to <strong>Air Conditioner</strong></li>
<li>Click on the <strong>Add Inventory Item</strong> button to add the new item.  Your browser will be redirected back to inventory listing page.</li>
</ul>
</li>
<li>
<p>Notice that you now have an entry in the table.  Click on the <strong>SelectedItemType</strong> dropdown once again and select <strong>HandTools</strong>, then click on the <strong>Select</strong> button.</p>
<ul>
<li>Add a <strong>Hammer</strong> as a new new <em>Handtools</em> product.</li>
<li>Add a <strong>Screwdriver</strong> as a new *Handtools product.</li>
</ul>
<p><a href="Images/communicate-show_handtools.png" target="_blank"><img src="Images/communicate-show_handtools.png" alt="Inventory Listing Showing Hand-Tools" style="max-width:100%;"></a></p>
<p><em>Inventory Listing Showing Hand-Tools</em></p>
</li>
<li>
<p>Click on the <strong>Increase</strong> link on the <em>Hammer</em> row.  In the <em>Add Inventory</em> page, set the <strong>Quantity</strong> to <strong>10</strong> and click on the <strong>Add Inventory</strong> button.  You browser will once again be redirected to the inventory listing page.  Notice the updated quantity for hammers.</p>
</li>
<li>
<p>Repeat the previous instruction, but instead click on the <strong>Decrease</strong> link and leave the <strong>Quantity</strong> to <strong>1</strong> when you click on the <strong>Remove Inventory</strong> button.  Observe the updated quantity on the inventory listing page.</p>
<blockquote>
<p>Bear in mind that in order to keep the demo lab simple, the inventory service has very little validation logic.  In a production application, for example, you would include checks in the Remove Inventory function to be sure that you could not remove more than the available. inventory, among others.</p>
</blockquote>
</li>
<li>
<p>Close your browser and stop the debugger in Visual Studio 2017.</p>
</li>
</ol>
<p><a name="Exercise5"></a></p>
<h2>Exercise 5: Enable Partitioning and Show Node Failover</h2>
<p>This final exercise will demonstrate some of the scalability and resiliency features built into Service Fabric.  You will first update the partitioning scheme for the <em>Inventory Repository</em> service that you have previously created, in order to segment the functionality for each Inventory Item Type to a different partition within the cluster.  Then you will use the Service Fabric Explorer that you first explored in Exercise 2 in order to simulate a node failure in your cluster and to see how partition replicas for Reliable Services in Service Fabric help to provide a more fault-tolerant system.</p>
<ol>
<li>
<p>The first step is to update the Service Fabric runtime information for the <em>Inventory Repository</em> service.  The service will maintain 3 replicas per partition for durability.  Furthermore, to simulate performance considerations, the data will be partitioned across 10 distinct partitions, by each distinct Inventory Item Type.</p>
<blockquote>
<p>Partitioning is a useful performance technique for distributing load accross your system.  As long as you select a good approach which yields a generally uniform distribution across your resources, it can help make sure that no one section of your cluster is particularly overloaded.  You can learn more about partitioning in Service Fabric <a href="https://docs.microsoft.com/en-us/azure/service-fabric/service-fabric-concepts-partitioning">here</a>.  One important note with Service Fabric partitions - you cannot change the partition count of a deployed Service Fabric application once it has been deployed without first tearing down the application, so it is important to plan &amp; test your partitioning strategy ahead of time or you will risk service downtime if and when you need to reset.</p>
</blockquote>
</li>
<li>
<p>In the Solution Explorer in Visual Studio 2017, locate the <strong>ServiceFabricLab</strong> project, expand the <strong>ApplicationPackageRoot</strong> folder and open the <strong>ApplicationManifest.xml</strong> file.</p>
</li>
<li>
<p>In the <em>ApplicationManifest.xml</em> file, update the <code>InventoryRepository_PartitionCount</code> value to 10 and add new values for the partition low key and partition high key settings.</p>
<div class="highlight highlight-text-xml"><pre>&lt;<span class="pl-ent">Parameter</span> <span class="pl-e">Name</span>=<span class="pl-s"><span class="pl-pds">"</span>InventoryRepository_PartitionCount<span class="pl-pds">"</span></span> <span class="pl-e">DefaultValue</span>=<span class="pl-s"><span class="pl-pds">"</span>10<span class="pl-pds">"</span></span> /&gt;
&lt;<span class="pl-ent">Parameter</span> <span class="pl-e">Name</span>=<span class="pl-s"><span class="pl-pds">"</span>Inventory_PartitionLowKey<span class="pl-pds">"</span></span> <span class="pl-e">DefaultValue</span>=<span class="pl-s"><span class="pl-pds">"</span>0<span class="pl-pds">"</span></span> /&gt;
&lt;<span class="pl-ent">Parameter</span> <span class="pl-e">Name</span>=<span class="pl-s"><span class="pl-pds">"</span>Inventory_PartitionHighKey<span class="pl-pds">"</span></span> <span class="pl-e">DefaultValue</span>=<span class="pl-s"><span class="pl-pds">"</span>9<span class="pl-pds">"</span></span> /&gt;</pre></div>
</li>
<li>
<p>Also in the  <em>ApplicationManifest.xml</em> file, locate the <code>UniformInt64Partition</code> element and update its <code>LowKey</code> and <code>HighKey</code> values to use the settings you just added:</p>
<div class="highlight highlight-text-xml"><pre>&lt;<span class="pl-ent">UniformInt64Partition</span> <span class="pl-e">PartitionCount</span>=<span class="pl-s"><span class="pl-pds">"</span>[InventoryRepository_PartitionCount]<span class="pl-pds">"</span></span> <span class="pl-e">LowKey</span>=<span class="pl-s"><span class="pl-pds">"</span>[Inventory_PartitionLowKey]<span class="pl-pds">"</span></span> <span class="pl-e">HighKey</span>=<span class="pl-s"><span class="pl-pds">"</span>[Inventory_PartitionHighKey]<span class="pl-pds">"</span></span> /&gt;</pre></div>
</li>
<li>
<p>Open the <em>ApplicationParameters</em> folder and update the each of the setting XML files (there are 3 - <em>Cloud.xml</em>, <em>Local.1Node.xml</em>, and <em>Local.5Node.xml</em>) with the new <code>InventoryRepository_PartitionCount</code> value.</p>
<div class="highlight highlight-text-xml"><pre>&lt;<span class="pl-ent">Parameter</span> <span class="pl-e">Name</span>=<span class="pl-s"><span class="pl-pds">"</span>InventoryRepository_PartitionCount<span class="pl-pds">"</span></span> <span class="pl-e">Value</span>=<span class="pl-s"><span class="pl-pds">"</span>10<span class="pl-pds">"</span></span> /&gt;</pre></div>
<blockquote>
<p>These xml files are settings files that you can use to customize different values for different Service Fabric deployments.  In the default configuration, you have 1 file each for the 2 deployment options that are available in your Service Fabric Local Cluster Manager, and one file for your standard Cloud deployment options.  The values in these files override the corresponding <code>Parameter</code> value declared inside of the <em>ApplicationManifest.xml</em> file.</p>
</blockquote>
</li>
<li>
<p>Open the <strong>HomeController.cs</strong> file located in the <strong>Controllers</strong> folder in the <em>InventoryService</em> project.  Search for each instance of the code <code>new ServicePartitionKey(0)</code> and replace it with the corresponding value shown below:</p>
<ul>
<li>In the <code>Index</code> method, replace it with <code>new ServicePartitionKey((Int64)selectedItemType)</code></li>
<li>In the <code>AddNewInventoryItem</code> method, replace it with <code>new ServicePartitionKey((Int64)newItem.ItemType)</code></li>
<li>In the first <code>AddInventory</code> method, replace it with <code>new ServicePartitionKey((Int64)selectedItemType)</code></li>
<li>In the second <code>AddInventory</code> method, replace it with <code>new ServicePartitionKey((Int64)viewModel.ItemType)</code></li>
<li>In the first <code>RemoveInventory</code> method, replace it with <code>new ServicePartitionKey((Int64)selectedItemType)</code></li>
<li>In the second <code>RemoveInventory</code> method, replace it with <code>new ServicePartitionKey((Int64)viewModel.ItemType)</code></li>
</ul>
<p>Your application is now ready to run using Service Fabric partitioning.  Calls from the <em>Inventory Service</em> to the <em>Inventory Repository</em> use the currently selected inventory item type to configure a <code>ServicePartitionKey</code> value, which is used by the <code>ServicePartitionClient</code> to find the address it should use for calls to the <em>Inventory Repository</em> service.</p>
</li>
<li>
<p>Once again, start debugging your application and add several inventory items, as you did in Exercise 4, starting at Step 17.  Be sure you include at least one item in the <em>HandTools</em> category.</p>
</li>
<li>
<p>Like you did in Exercise 2, with your application still running, locate the <em>Service Fabric Local Cluster Manager</em> icon in the Windows System Tray.  Right-click on the icon and select <strong>Manage Local Cluster</strong> from the menu that is displayed in order to bring open the <em>Service Fabric Explorer</em> for your site in your Web browser.</p>
</li>
<li>
<p>In the <em>Service Fabric Explorer</em>, expand the <strong>Applications</strong> node, then the <strong>ServiceFabricLabType</strong> node, then the <strong>fabric:/ServiceFabricLab</strong> node, and then finally the <strong>fabric:/ServiceFabricLab/InventoryRepository</strong> node.</p>
<p><a href="Images/partition-explorer_expandservice.png" target="_blank"><img src="Images/partition-explorer_expandservice.png" alt="Expanding the Service Fabric Explorer Nodes" style="max-width:100%;"></a></p>
<p><em>Expanding the Service Fabric Explorer Nodes</em></p>
<p>Notice that the <em>InventoryRepository</em> node has 10 children underneath it - one for each partition that has been configured for the service.</p>
</li>
<li>
<p>Click on each one of the partition entries underneath the <strong>fabric:/ServiceFabricLab/InventoryRepository</strong> node until you find one where the <em>Low Key</em> and <em>High Key</em> values are <strong>3</strong>, which corresponds to the value for the <code>HandTools</code> member of the <code>InventoryItemType</code> enumeration.</p>
<p><a href="Images/partition-explorer_locatehandtools.png" target="_blank"><img src="Images/partition-explorer_locatehandtools.png" alt="Locating the HandTools Partition" style="max-width:100%;"></a></p>
<p><em>Locating the HandTools Partition</em></p>
</li>
<li>
<p>Once you have located the <code>HandTools</code> partition, locate the <strong>Replicas</strong> display in the bottom of the window.  These are the nodes in your cluster where the replicas for the selected partition are deployed.  Find the row that corresponds to the <strong>Primary</strong> replica and make a note of the <strong>Node Name</strong> value.</p>
<blockquote>
<p>In the image above, you can see that <em>_Node_2</em> hosts the <em>Primary Replica</em> for the <em>HandTools</em> partition, and <em>_Node_1</em> and <em>_Node_3</em> each host <em>Active Secondary Replicas</em>.</p>
</blockquote>
</li>
<li>
<p>Expand the <strong>Nodes</strong> section in the Service Fabric Explorer tree view on the left and click the node whose name matches the value your found in the previous step.</p>
<p><a href="Images/partition-explorer_selectprimaryreplicanode.png" target="_blank"><img src="Images/partition-explorer_selectprimaryreplicanode.png" alt="Selecting the Primary Replica Node" style="max-width:100%;"></a></p>
<p><em>Selecting the Primary Replica Node</em></p>
</li>
<li>
<p>Locate and then click on the <strong>Actions</strong> dropdown in the top right corner of the page shown for the selected node.  In the context menu that is displayed, click on <strong>Deactivate (restart)</strong></p>
<p><a href="Images/partition-explorer_deactivating.png" target="_blank"><img src="Images/partition-explorer_deactivating.png" alt="Deactivating the Primary Replica Node" style="max-width:100%;"></a></p>
<p><em>Deactivating the Primary Replica Node</em></p>
</li>
<li>
<p>In the <em>Confirm Node Deactivation</em> dialog, type the name of the node into the text box as per the instructions and then click on the <strong>Deactivate (restart)</strong> button.</p>
<p><a href="Images/partition-explorer_confirmdeactivate.png" target="_blank"><img src="Images/partition-explorer_confirmdeactivate.png" alt="Confirming Node Deactivation" style="max-width:100%;"></a></p>
<p><em>Confirming Node Deactivation</em></p>
<p>This will kick deactivate the node you selected.  The process will take a couple minutes, during which Service Fabric will detect the non-functional node and rebalance the partitions and replicas across the remaining partitions.</p>
</li>
<li>
<p>The Service Fabric Explorer will update to show that it has detected problems with the current cluster.</p>
<p>Click once again on the partition identifier that you previously selected in Step 10.  You will also be able to see the updated Replica distribution for your partition.</p>
<p><a href="Images/partition-explorer_afterdeactivation.png" target="_blank"><img src="Images/partition-explorer_afterdeactivation.png" alt="The Service Fabric Explorer After Deactivation" style="max-width:100%;"></a></p>
<p><em>The Service Fabric Explorer After Deactivation</em></p>
<p>In the picture above, you can see that the _Node_1 now hosts the Primary Replica for the HandTools partition.</p>
</li>
<li>
<p>Switch to the browser window for your service.  If it isn't already selected, select <strong>HandTools</strong> from the <strong>SelectedItemType</strong> pulldown and click on the <strong>Select</strong> button.  This will make a request from your <em>InventoryService Service</em> to the <em>InventoryRepository Service</em>, fetching and then using the new URL for the node where your HandTools partition is housed.</p>
<p><a href="Images/partition-browse_afternodefailure.png" target="_blank"><img src="Images/partition-browse_afternodefailure.png" alt="Using the Service Fabric Service After Node Failure" style="max-width:100%;"></a></p>
<p><em>Using the Service Fabric Service After Node Failure</em></p>
</li>
<li>
<p>Return to the Service Fabric Explorer and click on the node entry that you deactivated in Step 13.  Locate and then click on the <strong>Actions</strong> dropdown in the top right corner of the page shown for the selected node.  In the context menu that is displayed, click on <strong>Activate</strong>.</p>
<p>Once again, Service Fabric will notice a change to the nodes that it is managing, and will rebalance its partition replicas to take advantage of the now-available node.</p>
<p>After a few seconds, the warnings and errors in the Service Fabric Explorer will disappear and will reflect the now-stable status of the cluster.</p>
</li>
<li>
<p>Close your browser and stop debugging in Visual Studio 2017.</p>
</li>
</ol>
<p><a name="Summary"></a></p>
<h2>Summary</h2>
<p>In this hands-on lab, you learned how to:</p>
<ul>
<li>Create a new Service Fabric application using Visual Studio 2017.</li>
<li>Use the debugging and diagnostic tools provided by both Visual Studio and Service Fabric itself to run and monitor your Service Fabric application.</li>
<li>Configure communication between multiple services in a Service Fabric application.</li>
<li>Leverage partitioning and Reliable Services in order to provide scalability and fault-tolerance in a Service Fabric application.</li>
</ul>
<p>The application you built was fairly simple - it included a front-end display service and an inventory repository service.  A more complete Microservices implementation might consist of several additional services communicating with each other and leveraging the Service Fabric infrastructure to resolve locations and addresses.  In some cases, individual services might be assigned to specific subsets of the cluster that Service Fabric is managing, allowing different services to scale independently - a hallmark of a true Microservices implementation.</p>
<p>As you have seen, using Azure Service Fabric it is possible to create applications that consist of several different kinds of services and to deploy them within a framework that supports both scalability and reliability.</p>
<hr>
<p>Copyright 2017 Microsoft Corporation. All rights reserved. Except where otherwise noted, these materials are licensed under the terms of the MIT License. You may use them according to the license as is most appropriate for your project. The terms of this license can be found at <a href="https://opensource.org/licenses/MIT">https://opensource.org/licenses/MIT</a>.</p>
</body>
</html>
<!-- This document was created with MarkdownPad, the Markdown editor for Windows (http://markdownpad.com) -->
